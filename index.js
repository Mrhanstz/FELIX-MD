InVzZSBzdHJpY3QiOwoKdmFyIF9fY3JlYXRlQmluZGluZyA9IHRoaXMgJiYgdGhpcy5fX2NyZWF0ZUJpbmRpbmcgfHwgKE9iamVjdC5jcmVhdGUgPyBmdW5jdGlvbiAobywgbSwgaywgazIpIHsKICBpZiAoazIgPT09IHVuZGVmaW5lZCkgewogICAgazIgPSBrOwogIH0KICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IobSwgayk7CiAgaWYgKCFkZXNjIHx8ICgiZ2V0IiBpbiBkZXNjID8gIW0uX19lc01vZHVsZSA6IGRlc2Mud3JpdGFibGUgfHwgZGVzYy5jb25maWd1cmFibGUpKSB7CiAgICBkZXNjID0gewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbVtrXTsKICAgICAgfQogICAgfTsKICB9CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCBkZXNjKTsKfSA6IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogIGlmIChrMiA9PT0gdW5kZWZpbmVkKSB7CiAgICBrMiA9IGs7CiAgfQogIG9bazJdID0gbVtrXTsKfSk7CnZhciBfX3NldE1vZHVsZURlZmF1bHQgPSB0aGlzICYmIHRoaXMuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIHYpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkobywgImRlZmF1bHQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgdmFsdWU6IHYKICB9KTsKfSA6IGZ1bmN0aW9uIChvLCB2KSB7CiAgb1siZGVmYXVsdCJdID0gdjsKfSk7CnZhciBfX2ltcG9ydFN0YXIgPSB0aGlzICYmIHRoaXMuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uIChtb2QpIHsKICBpZiAobW9kICYmIG1vZC5fX2VzTW9kdWxlKSB7CiAgICByZXR1cm4gbW9kOwogIH0KICB2YXIgcmVzdWx0ID0ge307CiAgaWYgKG1vZCAhPSBudWxsKSB7CiAgICBmb3IgKHZhciBrIGluIG1vZCkgaWYgKGsgIT09ICJkZWZhdWx0IiAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobW9kLCBrKSkgewogICAgICBfX2NyZWF0ZUJpbmRpbmcocmVzdWx0LCBtb2QsIGspOwogICAgfQogIH0KICBfX3NldE1vZHVsZURlZmF1bHQocmVzdWx0LCBtb2QpOwogIHJldHVybiByZXN1bHQ7Cn07CnZhciBfX2ltcG9ydERlZmF1bHQgPSB0aGlzICYmIHRoaXMuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKICByZXR1cm4gbW9kICYmIG1vZC5fX2VzTW9kdWxlID8gbW9kIDogewogICAgImRlZmF1bHQiOiBtb2QKICB9Owp9OwpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmNvbnN0IGJhaWxleXNfMSA9IF9faW1wb3J0U3RhcihyZXF1aXJlKCJAd2hpc2tleXNvY2tldHMvYmFpbGV5cyIpKTsKY29uc3QgbG9nZ2VyXzEgPSBfX2ltcG9ydERlZmF1bHQocmVxdWlyZSgiQHdoaXNrZXlzb2NrZXRzL2JhaWxleXMvbGliL1V0aWxzL2xvZ2dlciIpKTsKY29uc3QgbG9nZ2VyID0gbG9nZ2VyXzEuZGVmYXVsdC5jaGlsZCh7fSk7CmxvZ2dlci5sZXZlbCA9ICdzaWxlbnQnOwpjb25zdCBwaW5vID0gcmVxdWlyZSgicGlubyIpOwpjb25zdCBib29tXzEgPSByZXF1aXJlKCJAaGFwaS9ib29tIik7CmNvbnN0IGNvbmYgPSByZXF1aXJlKCIuL3NldCIpOwpsZXQgZnMgPSByZXF1aXJlKCJmcy1leHRyYSIpOwpsZXQgcGF0aCA9IHJlcXVpcmUoInBhdGgiKTsKY29uc3QgRmlsZVR5cGUgPSByZXF1aXJlKCdmaWxlLXR5cGUnKTsKY29uc3QgewogIFN0aWNrZXIsCiAgY3JlYXRlU3RpY2tlciwKICBTdGlja2VyVHlwZXMKfSA9IHJlcXVpcmUoJ3dhLXN0aWNrZXItZm9ybWF0dGVyJyk7Ci8vaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJwpjb25zdCB7CiAgdmVyaWZpZXJFdGF0SmlkLAogIHJlY3VwZXJlckFjdGlvbkppZAp9ID0gcmVxdWlyZSgiLi9iZGQvYW50aWxpZW4iKTsKY29uc3QgewogIGF0YnZlcmlmaWVyRXRhdEppZCwKICBhdGJyZWN1cGVyZXJBY3Rpb25KaWQKfSA9IHJlcXVpcmUoIi4vYmRkL2FudGlib3QiKTsKbGV0IGV2dCA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi9oYW5zdHovaGFucyIpOwpjb25zdCB7CiAgaXNVc2VyQmFubmVkLAogIGFkZFVzZXJUb0Jhbkxpc3QsCiAgcmVtb3ZlVXNlckZyb21CYW5MaXN0Cn0gPSByZXF1aXJlKCIuL2JkZC9iYW5Vc2VyIik7CmNvbnN0IHsKICBhZGRHcm91cFRvQmFuTGlzdCwKICBpc0dyb3VwQmFubmVkLAogIHJlbW92ZUdyb3VwRnJvbUJhbkxpc3QKfSA9IHJlcXVpcmUoIi4vYmRkL2Jhbkdyb3VwIik7CmNvbnN0IHsgYW50aXNwYW1GdW5jdGlvbnN9ID0gcmVxdWlyZSgiLi9iZGQvYW50aXNwYW0iKTsKY29uc3QgewogIGlzR3JvdXBPbmx5QWRtaW4sCiAgYWRkR3JvdXBUb09ubHlBZG1pbkxpc3QsCiAgcmVtb3ZlR3JvdXBGcm9tT25seUFkbWluTGlzdAp9ID0gcmVxdWlyZSgiLi9iZGQvb25seUFkbWluIik7Ci8vY29uc3QgLy97bG9hZENtZH09cmVxdWlyZSgiL2hhbnN0ei9tZXNmb25jdGlvbnMiKQpsZXQgewogIHJlYWdpcgp9ID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAiL2hhbnN0ei9hcHAiKTsKdmFyIHNlc3Npb24gPSBjb25mLnNlc3Npb24ucmVwbGFjZSgvRkVMSVgtTUQ7Ozs9Pi9nLCAiIik7CmNvbnN0IHByZWZpeGUgPSBjb25mLlBSRUZJWEU7CnJlcXVpcmUoJ2RvdGVudicpLmNvbmZpZyh7CiAgJ3BhdGgnOiAiLi9jb25maWcuZW52Igp9KTsKYXN5bmMgZnVuY3Rpb24gYXV0aGVudGlmaWNhdGlvbigpIHsKICB0cnkgewogICAgLy9jb25zb2xlLmxvZygibGUgZGF0YSAiK2RhdGEpCiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoX19kaXJuYW1lICsgIi9hdXRoL2NyZWRzLmpzb24iKSkgewogICAgICBjb25zb2xlLmxvZygiY29ubmVjdGVkIHN1Y2Nlc3NmdWxseS4uLiIpOwogICAgICBhd2FpdCBmcy53cml0ZUZpbGVTeW5jKF9fZGlybmFtZSArICIvYXV0aC9jcmVkcy5qc29uIiwgYXRvYihzZXNzaW9uKSwgInV0ZjgiKTsKICAgICAgLy9jb25zb2xlLmxvZyhzZXNzaW9uKQogICAgfSBlbHNlIGlmIChmcy5leGlzdHNTeW5jKF9fZGlybmFtZSArICIvYXV0aC9jcmVkcy5qc29uIikgJiYgc2Vzc2lvbiAhPSAiem9rayIpIHsKICAgICAgYXdhaXQgZnMud3JpdGVGaWxlU3luYyhfX2Rpcm5hbWUgKyAiL2F1dGgvY3JlZHMuanNvbiIsIGF0b2Ioc2Vzc2lvbiksICJ1dGY4Iik7CiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgY29uc29sZS5sb2coIlNlc3Npb24gSW52YWxpZCAiICsgZSk7CiAgICByZXR1cm47CiAgfQp9CmF1dGhlbnRpZmljYXRpb24oKTsKMDsKY29uc3Qgc3RvcmUgPSBiYWlsZXlzXzEubWFrZUluTWVtb3J5U3RvcmUoewogIGxvZ2dlcjogcGlubygpLmNoaWxkKHsKICAgIGxldmVsOiAic2lsZW50IiwKICAgIHN0cmVhbTogInN0b3JlIgogIH0pCn0pOwpzZXRUaW1lb3V0KCgpID0+IHsKICBhc3luYyBmdW5jdGlvbiBtYWluKCkgewogICAgMDsKICAgIGNvbnN0IHsKICAgICAgdmVyc2lvbiwKICAgICAgaXNMYXRlc3QKICAgIH0gPSBhd2FpdCBiYWlsZXlzXzEuZmV0Y2hMYXRlc3RCYWlsZXlzVmVyc2lvbigpOwogICAgMDsKICAgIGNvbnN0IHsKICAgICAgc3RhdGUsCiAgICAgIHNhdmVDcmVkcwogICAgfSA9IGF3YWl0IGJhaWxleXNfMS51c2VNdWx0aUZpbGVBdXRoU3RhdGUoX19kaXJuYW1lICsgIi9hdXRoIik7CiAgICAwOwogICAgY29uc3Qgc29ja09wdGlvbnMgPSB7CiAgICAgIHZlcnNpb24sCiAgICAgIGxvZ2dlcjogcGlubyh7CiAgICAgICAgbGV2ZWw6ICJzaWxlbnQiCiAgICAgIH0pLAogICAgICBicm93c2VyOiBbJ0ZFTElYLU1EJywgInNhZmFyaSIsICIxLjAuMCJdLAogICAgICBwcmludFFSSW5UZXJtaW5hbDogdHJ1ZSwKICAgICAgZmlyZUluaXRRdWVyaWVzOiBmYWxzZSwKICAgICAgc2hvdWxkU3luY0hpc3RvcnlNZXNzYWdlOiB0cnVlLAogICAgICBkb3dubG9hZEhpc3Rvcnk6IHRydWUsCiAgICAgIHN5bmNGdWxsSGlzdG9yeTogdHJ1ZSwKICAgICAgZ2VuZXJhdGVIaWdoUXVhbGl0eUxpbmtQcmV2aWV3OiB0cnVlLAogICAgICBtYXJrT25saW5lT25Db25uZWN0OiBmYWxzZSwKICAgICAga2VlcEFsaXZlSW50ZXJ2YWxNczogMzBfMDAwLAogICAgICAvKiBhdXRoOiBzdGF0ZSovYXV0aDogewogICAgICAgIGNyZWRzOiBzdGF0ZS5jcmVkcywKICAgICAgICAvKiogY2FjaGluZyBtYWtlcyB0aGUgc3RvcmUgZmFzdGVyIHRvIHNlbmQvcmVjdiBtZXNzYWdlcyAqLwogICAgICAgIGtleXM6IGJhaWxleXNfMS5tYWtlQ2FjaGVhYmxlU2lnbmFsS2V5U3RvcmUoc3RhdGUua2V5cywgbG9nZ2VyKQogICAgICB9LAogICAgICAvLy8vLy8vLy8vCiAgICAgIGdldE1lc3NhZ2U6IGFzeW5jIGtleSA9PiB7CiAgICAgICAgaWYgKHN0b3JlKSB7CiAgICAgICAgICBjb25zdCBtc2cgPSBhd2FpdCBzdG9yZS5sb2FkTWVzc2FnZShrZXkucmVtb3RlSmlkLCBrZXkuaWQsIHVuZGVmaW5lZCk7CiAgICAgICAgICByZXR1cm4gbXNnLm1lc3NhZ2UgfHwgdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgY29udmVyc2F0aW9uOiAnQW4gRXJyb3IgT2NjdXJyZWQsIFJlcGVhdCBDb21tYW5kIScKICAgICAgICB9OwogICAgICB9CiAgICAgIC8vLy8vLy8KICAgIH07CgogICAgMDsKICAgIGNvbnN0IHprID0gYmFpbGV5c18xLmRlZmF1bHQoc29ja09wdGlvbnMpOwogICAgc3RvcmUuYmluZCh6ay5ldik7CiAgICBzZXRJbnRlcnZhbCgoKSA9PiB7CiAgICAgIHN0b3JlLndyaXRlVG9GaWxlKCJzdG9yZS5qc29uIik7CiAgICB9LCAzMDAwKTsKICAgIHprLmV2Lm9uKCJjYWxsIiwgYXN5bmMgY2FsbERhdGEgPT4gewogICAgICBpZiAoY29uZi5BTlRJQ0FMTCA9PT0gJ3llcycpIHsKICAgICAgICBjb25zdCBjYWxsSWQgPSBjYWxsRGF0YVswXS5pZDsKICAgICAgICBjb25zdCBjYWxsZXJJZCA9IGNhbGxEYXRhWzBdLmZyb207CiAgICAgICAgYXdhaXQgemsucmVqZWN0Q2FsbChjYWxsSWQsIGNhbGxlcklkKTsKICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShjYWxsZXJJZCwgewogICAgICAgICAgdGV4dDogImBg+P31SSBBTSBGZWxpeCBNZCB8IEkgUkVKRUNUIFRISVMgQ0FMTCBCRUNBVVNFIE1ZIE9XTkVSIElTIEJVU1kuS0lORExZIFNFTkQgVEVYVCBJTlNURUFEYGBgIC4iCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgLy8gRnVuY3Rpb24gdG8gZm9ybWF0IG5vdGlmaWNhdGlvbiBtZXNzYWdlCmZ1bmN0aW9uIGNyZWF0ZU5vdGlmaWNhdGlvbihkZWxldGVkTWVzc2FnZSkgewogIGNvbnN0IGRlbGV0ZWRCeSA9IGRlbGV0ZWRNZXNzYWdlLmtleS5wYXJ0aWNpcGFudCB8fCBkZWxldGVkTWVzc2FnZS5rZXkucmVtb3RlSmlkOwogIGxldCBub3RpZmljYXRpb24gPSBgKkZFTElYIEFOVElERUxFVEUqXG5cbmA7CiAgbm90aWZpY2F0aW9uICs9IGAqVGltZSBkZWxldGVk/0A6KiAke25ldyBEYXRlKCkudG9Mb2NhbGVTdHJpbmcoKX1cbmA7CiAgbm90aWZpY2F0aW9uICs9IGAqRGVsZXRlZCBi+f83OiogQCR7ZGVsZXRlZEJ5LnNwbGl0KCdAJylbMF19XG5cbipQb3dlcmVkIGJ5IEhBTlNUWipcblxuYDsKICByZXR1cm4gbm90aWZpY2F0aW9uOwp9CgovLyBIZWxwZXIgZnVuY3Rpb24gdG8gZG93bmxvYWQgbWVkaWEKYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRNZWRpYShtZXNzYWdlKSB7CiAgdHJ5IHsKICAgIGlmIChtZXNzYWdlLmltYWdlTWVzc2FnZSkgewogICAgICByZXR1cm4gYXdhaXQgemsuZG93bmxvYWRNZWRpYU1lc3NhZ2UobWVzc2FnZS5pbWFnZU1lc3NhZ2UpOwogICAgfSBlbHNlIGlmIChtZXNzYWdlLnZpZGVvTWVzc2FnZSkgewogICAgICByZXR1cm4gYXdhaXQgemsuZG93bmxvYWRNZWRpYU1lc3NhZ2UobWVzc2FnZS52aWRlb01lc3NhZ2UpOwogICAgfSBlbHNlIGlmIChtZXNzYWdlLmRvY3VtZW50TWVzc2FnZSkgewogICAgICByZXR1cm4gYXdhaXQgemsuZG93bmxvYWRNZWRpYU1lc3NhZ2UobWVzc2FnZS5kb2N1bWVudE1lc3NhZ2UpOwogICAgfSBlbHNlIGlmIChtZXNzYWdlLmF1ZGlvTWVzc2FnZSkgewogICAgICByZXR1cm4gYXdhaXQgemsuZG93bmxvYWRNZWRpYU1lc3NhZ2UobWVzc2FnZS5hdWRpb01lc3NhZ2UpOwogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0aWNrZXJNZXNzYWdlKSB7CiAgICAgIHJldHVybiBhd2FpdCB6ay5kb3dubG9hZE1lZGlhTWVzc2FnZShtZXNzYWdlLnN0aWNrZXJNZXNzYWdlKTsKICAgIH0gZWxzZSBpZiAobWVzc2FnZS52b2ljZU1lc3NhZ2UpIHsKICAgICAgcmV0dXJuIGF3YWl0IHprLmRvd25sb2FkTWVkaWFNZXNzYWdlKG1lc3NhZ2Uudm9pY2VNZXNzYWdlKTsKICAgIH0gZWxzZSBpZiAobWVzc2FnZS5naWZNZXNzYWdlKSB7CiAgICAgIHJldHVybiBhd2FpdCB6ay5kb3dubG9hZE1lZGlhTWVzc2FnZShtZXNzYWdlLmdpZk1lc3NhZ2UpOwogICAgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvciBkb3dubG9hZGluZyBtZWRpYToiLCBlcnJvcik7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBFdmVudCBsaXN0ZW5lciBmb3IgYWxsIGluY29taW5nIG1lc3NhZ2VzCnprLmV2Lm9uKCJtZXNzYWdlcy51cHNlcnQiLCBhc3luYyBtID0+IHsKICAvLyBDaGVjayBpZiBBTlRJREVMRVRFIGlzIGVuYWJsZWQKICBpZiAoY29uZi5BRE0gPT09ICJ5ZXMiKSB7CiAgICBjb25zdCB7IG1lc3NhZ2VzIH0gPSBtOwogICAgY29uc3QgbXMgPSBtZXNzYWdlc1swXTsKCiAgICAvLyBJZiB0aGUgbWVzc2FnZSBoYXMgbm8gY29udGVudCwgaWdub3JlCiAgICBpZiAoIW1zLm1lc3NhZ2UpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIEdldCB0aGUgbWVzc2FnZSBrZXkgYW5kIHJlbW90ZSBKSUQgKGdyb3VwIG9yIGluZGl2aWR1YWwpCiAgICBjb25zdCBtZXNzYWdlS2V5ID0gbXMua2V5OwogICAgY29uc3QgcmVtb3RlSmlkID0gbWVzc2FnZUtleS5yZW1vdGVKaWQ7CgogICAgLy8gU3RvcmUgbWVzc2FnZSBmb3IgZnV0dXJlIHVuZGVsZXRlIHJlZmVyZW5jZQogICAgaWYgKCFzdG9yZS5jaGF0c1tyZW1vdGVKaWRdKSB7CiAgICAgIHN0b3JlLmNoYXRzW3JlbW90ZUppZF0gPSBbXTsKICAgIH0KCiAgICAvLyBTYXZlIHRoZSByZWNlaXZlZCBtZXNzYWdlIHRvIHN0b3JhZ2UKICAgIHN0b3JlLmNoYXRzW3JlbW90ZUppZF0ucHVzaChtcyk7CgogICAgLy8gSGFuZGxlIGRlbGV0ZWQgbWVzc2FnZXMgKHdoZW4gcHJvdG9jb2xNZXNzYWdlIGlzIHByZXNlbnQgYW5kIHR5cGUgaXMgMCkKICAgIGlmIChtcy5tZXNzYWdlLnByb3RvY29sTWVzc2FnZSAmJiBtcy5tZXNzYWdlLnByb3RvY29sTWVzc2FnZS50eXBlID09PSAwKSB7CiAgICAgIGNvbnN0IGRlbGV0ZWRLZXkgPSBtcy5tZXNzYWdlLnByb3RvY29sTWVzc2FnZS5rZXk7CgogICAgICAvLyBTZWFyY2ggZm9yIHRoZSBkZWxldGVkIG1lc3NhZ2UgaW4gdGhlIHN0b3JlZCBtZXNzYWdlcwogICAgICBjb25zdCBjaGF0TWVzc2FnZXMgPSBzdG9yZS5jaGF0c1tyZW1vdGVKaWRdOwogICAgICBjb25zdCBkZWxldGVkTWVzc2FnZSA9IGNoYXRNZXNzYWdlcy5maW5kKG1zZyA9PiBtc2cua2V5LmlkID09PSBkZWxldGVkS2V5LmlkKTsKCiAgICAgIGlmIChkZWxldGVkTWVzc2FnZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAvLyBDcmVhdGUgbm90aWZpY2F0aW9uIGFib3V0IHRoZSBkZWxldGVkIG1lc3NhZ2UKICAgICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbiA9IGNyZWF0ZU5vdGlmaWNhdGlvbihkZWxldGVkTWVzc2FnZSk7CgogICAgICAgICAgLy8gQ2hlY2sgdGhlIHR5cGUgb2YgdGhlIGRlbGV0ZWQgbWVzc2FnZSAodGV4dCBvciBtZWRpYSkKICAgICAgICAgIGlmIChkZWxldGVkTWVzc2FnZS5tZXNzYWdlLmNvbnZlcnNhdGlvbikgewogICAgICAgICAgICAvLyBUZXh0IG1lc3NhZ2UKICAgICAgICAgICAgYXdhaXQgemsucmVsYXlNZXNzYWdlKHJlbW90ZUppZCwgZGVsZXRlZE1lc3NhZ2UsIHsKICAgICAgICAgICAgICBjYXB0aW9uOiBub3RpZmljYXRpb24sCiAgICAgICAgICAgICAgbWVudGlvbnM6IFtkZWxldGVkTWVzc2FnZS5rZXkucGFydGljaXBhbnRdCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS5pbWFnZU1lc3NhZ2UgfHwKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS52aWRlb01lc3NhZ2UgfHwKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS5kb2N1bWVudE1lc3NhZ2UgfHwKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS5hdWRpb01lc3NhZ2UgfHwKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS5zdGlja2VyTWVzc2FnZSB8fAogICAgICAgICAgICBkZWxldGVkTWVzc2FnZS5tZXNzYWdlLnZvaWNlTWVzc2FnZSB8fAogICAgICAgICAgICBkZWxldGVkTWVzc2FnZS5tZXNzYWdlLmdpZk1lc3NhZ2UKICAgICAgICAgICkgewogICAgICAgICAgICAvLyBNZWRpYSBtZXNzYWdlIChpbWFnZSwgdmlkZW8sIGRvY3VtZW50LCBhdWRpbywgc3RpY2tlciwgdm9pY2UsIGdpZikKICAgICAgICAgICAgY29uc3QgbWVkaWFCdWZmZXIgPSBhd2FpdCBkb3dubG9hZE1lZGlhKGRlbGV0ZWRNZXNzYWdlLm1lc3NhZ2UpOwogICAgICAgICAgICBpZiAobWVkaWFCdWZmZXIpIHsKICAgICAgICAgICAgICBsZXQgbWVkaWFUeXBlID0gJ2F1ZGlvJzsgLy8gRGVmYXVsdCB0byAnYXVkaW8nIGlmIG5vIG90aGVyIG1hdGNoCgogICAgICAgICAgICAgIC8vIERldGVybWluZSB0aGUgbWVkaWEgdHlwZQogICAgICAgICAgICAgIGlmIChkZWxldGVkTWVzc2FnZS5tZXNzYWdlLmltYWdlTWVzc2FnZSkgbWVkaWFUeXBlID0gJ2ltYWdlJzsKICAgICAgICAgICAgICBpZiAoZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS52aWRlb01lc3NhZ2UpIG1lZGlhVHlwZSA9ICd2aWRlbyc7CiAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRNZXNzYWdlLm1lc3NhZ2UuZG9jdW1lbnRNZXNzYWdlKSBtZWRpYVR5cGUgPSAnZG9jdW1lbnQnOwogICAgICAgICAgICAgIGlmIChkZWxldGVkTWVzc2FnZS5tZXNzYWdlLnN0aWNrZXJNZXNzYWdlKSBtZWRpYVR5cGUgPSAnc3RpY2tlcic7CiAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRNZXNzYWdlLm1lc3NhZ2Uudm9pY2VNZXNzYWdlKSBtZWRpYVR5cGUgPSAnYXVkaW8nOyAvLyBWb2ljZSBtZXNzYWdlcyBhcmUgdHJlYXRlZCBhcyBhdWRpbwogICAgICAgICAgICAgIGlmIChkZWxldGVkTWVzc2FnZS5tZXNzYWdlLmdpZk1lc3NhZ2UpIG1lZGlhVHlwZSA9ICd2aWRlbyc7IC8vIEdJRnMgYXJlIHRyZWF0ZWQgYXMgdmlkZW8KCiAgICAgICAgICAgICAgLy8gUmVsYXkgdGhlIG1lZGlhIHdpdGggbm90aWZpY2F0aW9uIGFuZCBwYXJ0aWNpcGFudCBtZW50aW9uCiAgICAgICAgICAgICAgYXdhaXQgemsucmVsYXlNZXNzYWdlKHJlbW90ZUppZCwgZGVsZXRlZE1lc3NhZ2UsIHsKICAgICAgICAgICAgICAgIFttZWRpYVR5cGVdOiBtZWRpYUJ1ZmZlciwKICAgICAgICAgICAgICAgIGNhcHRpb246IG5vdGlmaWNhdGlvbiwKICAgICAgICAgICAgICAgIG1lbnRpb25zOiBbZGVsZXRlZE1lc3NhZ2Uua2V5LnBhcnRpY2lwYW50XQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGhhbmRsaW5nIGRlbGV0ZWQgbWVzc2FnZTonLCBlcnJvcik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9KTsKCiAgICAvLyBUcmFjayBjb250YWN0cyB0aGF0IGhhdmUgYWxyZWFkeSByZWNlaXZlZCB0aGUgYXV0by1yZXBseQogICAgbGV0IHJlcGxpZWRDb250YWN0cyA9IG5ldyBTZXQoKTsKICAgIHprLmV2Lm9uKCJtZXNzYWdlcy51cHNlcnQiLCBhc3luYyBtID0+IHsKICAgICAgY29uc3QgewogICAgICAgIG1lc3NhZ2VzCiAgICAgIH0gPSBtOwogICAgICBjb25zdCBtcyA9IG1lc3NhZ2VzWzBdOwogICAgICBpZiAoIW1zLm1lc3NhZ2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgbWVzc2FnZVRleHQgPSBtcy5tZXNzYWdlLmNvbnZlcnNhdGlvbiB8fCBtcy5tZXNzYWdlLmV4dGVuZGVkVGV4dE1lc3NhZ2U/LnRleHQgfHwgIiI7CiAgICAgIGNvbnN0IHJlbW90ZUppZCA9IG1zLmtleS5yZW1vdGVKaWQ7CgogICAgICAvLyBHZXQgdGhlIHNlbmRlcidzIEpJRCBhbmQgbnVtYmVyCiAgICAgIGNvbnN0IHNlbmRlciA9IG1zLmtleS5yZW1vdGVKaWQ7CiAgICAgIGNvbnN0IHNlbmRlck51bWJlciA9IHNlbmRlci5zcGxpdCgnQCcpWzBdOwoKICAgICAgLy8gVXBkYXRlIHRoZSBhdXRvLXJlcGx5IG1lc3NhZ2UgZHluYW1pY2FsbHkKICAgICAgYXV0b19yZXBseV9tZXNzYWdlID0gYEhlbGxvIEAke3NlbmRlck51bWJlcn0sIEEgYnJpZWYgZGVwYXJ0dXJlIGlzIG9uIHRoZSBob3Jpem9uLCBidXQgSSBzaGFsbCByZXR1cm4gcG9zdGhhc3RlLiBQbGVhc2UgYmVhciB3aXRoIG1lIGZvciBhIGZsZWV0aW5nIG1vbWVudCwgYW5kIGkZbGwgcmVqb2luIHlvdSBzaG9ydGx5IFxuXG4qcG93ZXJlZCBieSBGZWxpeCBNZCouYDsKCiAgICAgIC8vIENoZWNrIGlmIHRoZSBtZXNzYWdlIGV4aXN0cyBhbmQgaXMgYSBjb21tYW5kIHRvIHNldCBhIG5ldyBhdXRvLXJlcGx5IG1lc3NhZ2Ugd2l0aCBhbnkgcHJlZml4CiAgICAgIGlmIChtZXNzYWdlVGV4dC5tYXRjaCgvXlteXHdcc10vKSAmJiBtcy5rZXkuZnJvbU1lKSB7CiAgICAgICAgY29uc3QgcHJlZml4ID0gbWVzc2FnZVRleHRbMF07IC8vIERldGVjdCB0aGUgcHJlZml4CiAgICAgICAgY29uc3QgY29tbWFuZCA9IG1lc3NhZ2VUZXh0LnNsaWNlKDEpLnNwbGl0KCIgIilbMF07IC8vIENvbW1hbmQgYWZ0ZXIgcHJlZml4CiAgICAgICAgY29uc3QgbmV3TWVzc2FnZSA9IG1lc3NhZ2VUZXh0LnNsaWNlKHByZWZpeC5sZW5ndGggKyBjb21tYW5kLmxlbmd0aCkudHJpbSgpOyAvLyBOZXcgbWVzc2FnZSBjb250ZW50CgogICAgICAgIC8vIFVwZGF0ZSB0aGUgYXV0by1yZXBseSBtZXNzYWdlIGlmIHRoZSBjb21tYW5kIGlzICdzZXRhdXRvcmVwbHknCiAgICAgICAgaWYgKGNvbW1hbmQgPT09ICJzZXRhdXRvcmVwbHkiICYmIG5ld01lc3NhZ2UpIHsKICAgICAgICAgIGF1dG9fcmVwbHlfbWVzc2FnZSA9IG5ld01lc3NhZ2U7CiAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShyZW1vdGVKaWQsIHsKICAgICAgICAgICAgdGV4dDogYEF1dG8tcmVwbHkgbWVzc2FnZSBoYXMgYmVlbiB1cGRhdGVkIHRvOlxuIiR7YXV0b19yZXBseV9tZXNzYWdlfSJgCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIENoZWNrIGlmIGF1dG8tcmVwbHkgaXMgZW5hYmxlZCwgY29udGFjdCBoYXNuJ3QgcmVjZWl2ZWQgYSByZXBseSwgYW5kIGl0J3MgYSBwcml2YXRlIGNoYXQKICAgICAgaWYgKGNvbmYuQVVUT19SRVBMWSA9PT0gInllcyIgJiYgIXJlcGxpZWRDb250YWN0cy5oYXMocmVtb3RlSmlkKSAmJiAhbXMua2V5LmZyb21NZSAmJiAhcmVtb3RlSmlkLmluY2x1ZGVzKCJAZy51cyIpKSB7CiAgICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2UocmVtb3RlSmlkLCB7CiAgICAgICAgICB0ZXh0OiBhdXRvX3JlcGx5X21lc3NhZ2UsCiAgICAgICAgICBtZW50aW9uczogW3NlbmRlcl0KICAgICAgICB9KTsKCiAgICAgICAgLy8gQWRkIGNvbnRhY3QgdG8gcmVwbGllZCBzZXQgdG8gcHJldmVudCByZXBlYXQgcmVwbGllcwogICAgICAgIHJlcGxpZWRDb250YWN0cy5hZGQocmVtb3RlSmlkKTsKICAgICAgfQogICAgfSk7CiAgICAgLy8gRnVuY3Rpb24gdG8gZm9ybWF0IG5vdGlmaWNhdGlvbiBtZXNzYWdlCmZ1bmN0aW9uIGNyZWF0ZU5vdGlmaWNhdGlvbihkZWxldGVkTWVzc2FnZSkgewogIGNvbnN0IGRlbGV0ZWRCeSA9IGRlbGV0ZWRNZXNzYWdlLmtleS5wYXJ0aWNpcGFudCB8fCBkZWxldGVkTWVzc2FnZS5rZXkucmVtb3RlSmlkOwogIGxldCBub3RpZmljYXRpb24gPSBgKkZFTElYIEFOVElERUxFVEUqXG5cbmA7CiAgbm90aWZpY2F0aW9uICs9IGAqVGltZSBkZWxldGVk/0A6KiAke25ldyBEYXRlKCkudG9Mb2NhbGVTdHJpbmcoKX1cbmA7CiAgbm90aWZpY2F0aW9uICs9IGAqRGVsZXRlZCBi+f83OiogQCR7ZGVsZXRlZEJ5LnNwbGl0KCdAJylbMF19XG5cbipQb3dlcmVkIGJ5IEhBTlNUWipcblxuYDsKICByZXR1cm4gbm90aWZpY2F0aW9uOwp9CgovLyBIZWxwZXIgZnVuY3Rpb24gdG8gZG93bmxvYWQgbWVkaWEKYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRNZWRpYShtZXNzYWdlKSB7CiAgdHJ5IHsKICAgIGlmIChtZXNzYWdlLmltYWdlTWVzc2FnZSkgewogICAgICByZXR1cm4gYXdhaXQgemsuZG93bmxvYWRNZWRpYU1lc3NhZ2UobWVzc2FnZS5pbWFnZU1lc3NhZ2UpOwogICAgfSBlbHNlIGlmIChtZXNzYWdlLnZpZGVvTWVzc2FnZSkgewogICAgICByZXR1cm4gYXdhaXQgemsuZG93bmxvYWRNZWRpYU1lc3NhZ2UobWVzc2FnZS52aWRlb01lc3NhZ2UpOwogICAgfSBlbHNlIGlmIChtZXNzYWdlLmRvY3VtZW50TWVzc2FnZSkgewogICAgICByZXR1cm4gYXdhaXQgemsuZG93bmxvYWRNZWRpYU1lc3NhZ2UobWVzc2FnZS5kb2N1bWVudE1lc3NhZ2UpOwogICAgfSBlbHNlIGlmIChtZXNzYWdlLmF1ZGlvTWVzc2FnZSkgewogICAgICByZXR1cm4gYXdhaXQgemsuZG93bmxvYWRNZWRpYU1lc3NhZ2UobWVzc2FnZS5hdWRpb01lc3NhZ2UpOwogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0aWNrZXJNZXNzYWdlKSB7CiAgICAgIHJldHVybiBhd2FpdCB6ay5kb3dubG9hZE1lZGlhTWVzc2FnZShtZXNzYWdlLnN0aWNrZXJNZXNzYWdlKTsKICAgIH0gZWxzZSBpZiAobWVzc2FnZS52b2ljZU1lc3NhZ2UpIHsKICAgICAgcmV0dXJuIGF3YWl0IHprLmRvd25sb2FkTWVkaWFNZXNzYWdlKG1lc3NhZ2Uudm9pY2VNZXNzYWdlKTsKICAgIH0gZWxzZSBpZiAobWVzc2FnZS5naWZNZXNzYWdlKSB7CiAgICAgIHJldHVybiBhd2FpdCB6ay5kb3dubG9hZE1lZGlhTWVzc2FnZShtZXNzYWdlLmdpZk1lc3NhZ2UpOwogICAgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvciBkb3dubG9hZGluZyBtZWRpYToiLCBlcnJvcik7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBFdmVudCBsaXN0ZW5lciBmb3IgYWxsIGluY29taW5nIG1lc3NhZ2VzCnprLmV2Lm9uKCJtZXNzYWdlcy51cHNlcnQiLCBhc3luYyBtID0+IHsKICAvLyBDaGVjayBpZiBBTlRJREVMRVRFIGlzIGVuYWJsZWQKICBpZiAoY29uZi5BRE0gPT09ICJ5ZXMiKSB7CiAgICBjb25zdCB7IG1lc3NhZ2VzIH0gPSBtOwogICAgY29uc3QgbXMgPSBtZXNzYWdlc1swXTsKCiAgICAvLyBJZiB0aGUgbWVzc2FnZSBoYXMgbm8gY29udGVudCwgaWdub3JlCiAgICBpZiAoIW1zLm1lc3NhZ2UpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIEdldCB0aGUgbWVzc2FnZSBrZXkgYW5kIHJlbW90ZSBKSUQgKGdyb3VwIG9yIGluZGl2aWR1YWwpCiAgICBjb25zdCBtZXNzYWdlS2V5ID0gbXMua2V5OwogICAgY29uc3QgcmVtb3RlSmlkID0gbWVzc2FnZUtleS5yZW1vdGVKaWQ7CgogICAgLy8gU3RvcmUgbWVzc2FnZSBmb3IgZnV0dXJlIHVuZGVsZXRlIHJlZmVyZW5jZQogICAgaWYgKCFzdG9yZS5jaGF0c1tyZW1vdGVKaWRdKSB7CiAgICAgIHN0b3JlLmNoYXRzW3JlbW90ZUppZF0gPSBbXTsKICAgIH0KCiAgICAvLyBTYXZlIHRoZSByZWNlaXZlZCBtZXNzYWdlIHRvIHN0b3JhZ2UKICAgIHN0b3JlLmNoYXRzW3JlbW90ZUppZF0ucHVzaChtcyk7CgogICAgLy8gSGFuZGxlIGRlbGV0ZWQgbWVzc2FnZXMgKHdoZW4gcHJvdG9jb2xNZXNzYWdlIGlzIHByZXNlbnQgYW5kIHR5cGUgaXMgMCkKICAgIGlmIChtcy5tZXNzYWdlLnByb3RvY29sTWVzc2FnZSAmJiBtcy5tZXNzYWdlLnByb3RvY29sTWVzc2FnZS50eXBlID09PSAwKSB7CiAgICAgIGNvbnN0IGRlbGV0ZWRLZXkgPSBtcy5tZXNzYWdlLnByb3RvY29sTWVzc2FnZS5rZXk7CgogICAgICAvLyBTZWFyY2ggZm9yIHRoZSBkZWxldGVkIG1lc3NhZ2UgaW4gdGhlIHN0b3JlZCBtZXNzYWdlcwogICAgICBjb25zdCBjaGF0TWVzc2FnZXMgPSBzdG9yZS5jaGF0c1tyZW1vdGVKaWRdOwogICAgICBjb25zdCBkZWxldGVkTWVzc2FnZSA9IGNoYXRNZXNzYWdlcy5maW5kKG1zZyA9PiBtc2cua2V5LmlkID09PSBkZWxldGVkS2V5LmlkKTsKICAgICAgaWYgKGRlbGV0ZWRNZXNzYWdlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIC8vIENyZWF0ZSBub3RpZmljYXRpb24gYWJvdXQgdGhlIGRlbGV0ZWQgbWVzc2FnZQogICAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9uID0gY3JlYXRlTm90aWZpY2F0aW9uKGRlbGV0ZWRNZXNzYWdlKTsKCiAgICAgICAgICAvLyBDaGVjayB0aGUgdHlwZSBvZiB0aGUgZGVsZXRlZCBtZXNzYWdlICh0ZXh0IG9yIG1lZGlhKQogICAgICAgICAgaWYgKGRlbGV0ZWRNZXNzYWdlLm1lc3NhZ2UuY29udmVyc2F0aW9uKSB7CiAgICAgICAgICAgIC8vIFRleHQgbWVzc2FnZQogICAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShyZW1vdGVKaWQsIHsKICAgICAgICAgICAgICB0ZXh0OiBub3RpZmljYXRpb24gKyBgKk1lc3NhZ2U6KiAke2RlbGV0ZWRNZXNzYWdlLm1lc3NhZ2UuY29udmVyc2F0aW9ufWAsCiAgICAgICAgICAgICAgbWVudGlvbnM6IFtkZWxldGVkTWVzc2FnZS5rZXkucGFydGljaXBhbnRdCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS5pbWFnZU1lc3NhZ2UgfHwKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS52aWRlb01lc3NhZ2UgfHwKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS5kb2N1bWVudE1lc3NhZ2UgfHwKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS5hdWRpb01lc3NhZ2UgfHwKICAgICAgICAgICAgZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS5zdGlja2VyTWVzc2FnZSB8fAogICAgICAgICAgICBkZWxldGVkTWVzc2FnZS5tZXNzYWdlLnZvaWNlTWVzc2FnZSB8fAogICAgICAgICAgICBkZWxldGVkTWVzc2FnZS5tZXNzYWdlLmdpZk1lc3NhZ2UKICAgICAgICAgICkgewogICAgICAgICAgICAvLyBNZWRpYSBtZXNzYWdlIChpbWFnZSwgdmlkZW8sIGRvY3VtZW50LCBhdWRpbywgc3RpY2tlciwgdm9pY2UsIGdpZikKICAgICAgICAgICAgY29uc3QgbWVkaWFCdWZmZXIgPSBhd2FpdCBkb3dubG9hZE1lZGlhKGRlbGV0ZWRNZXNzYWdlLm1lc3NhZ2UpOwogICAgICAgICAgICBpZiAobWVkaWFCdWZmZXIpIHsKICAgICAgICAgICAgICBsZXQgbWVkaWFUeXBlID0gJ2F1ZGlvJzsgLy8gRGVmYXVsdCB0byAnYXVkaW8nIGlmIG5vIG90aGVyIG1hdGNoCgogICAgICAgICAgICAgIGlmIChkZWxldGVkTWVzc2FnZS5tZXNzYWdlLmltYWdlTWVzc2FnZSkgbWVkaWFUeXBlID0gJ2ltYWdlJzsKICAgICAgICAgICAgICBpZiAoZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS52aWRlb01lc3NhZ2UpIG1lZGlhVHlwZSA9ICd2aWRlbyc7CiAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRNZXNzYWdlLm1lc3NhZ2UuZG9jdW1lbnRNZXNzYWdlKSBtZWRpYVR5cGUgPSAnZG9jdW1lbnQnOwogICAgICAgICAgICAgIGlmIChkZWxldGVkTWVzc2FnZS5tZXNzYWdlLnN0aWNrZXJNZXNzYWdlKSBtZWRpYVR5cGUgPSAnc3RpY2tlcic7CiAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRNZXNzYWdlLm1lc3NhZ2Uudm9pY2VNZXNzYWdlKSBtZWRpYVR5cGUgPSAnYXVkaW8nOyAvLyBWb2ljZSBtZXNzYWdlcyBjYW4gYmUgdHJlYXRlZCBhcyBhdWRpbwogICAgICAgICAgICAgIGlmIChkZWxldGVkTWVzc2FnZS5tZXNzYWdlLmdpZk1lc3NhZ2UpIG1lZGlhVHlwZSA9ICd2aWRlbyc7IC8vIEdJRnMgYXJlIGdlbmVyYWxseSB2aWRlbyB0eXBlCgogICAgICAgICAgICAgIC8vIFNlbmQgdGhlIG1lZGlhIHdpdGggbm90aWZpY2F0aW9uIGFuZCBwYXJ0aWNpcGFudCBtZW50aW9uCiAgICAgICAgICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2UocmVtb3RlSmlkLCB7CiAgICAgICAgICAgICAgICBbbWVkaWFUeXBlXTogbWVkaWFCdWZmZXIsCiAgICAgICAgICAgICAgICBjYXB0aW9uOiBub3RpZmljYXRpb24sCiAgICAgICAgICAgICAgICBtZW50aW9uczogW2RlbGV0ZWRNZXNzYWdlLmtleS5wYXJ0aWNpcGFudF0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBoYW5kbGluZyBkZWxldGVkIG1lc3NhZ2U6JywgZXJyb3IpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KfSk7CgovLyBMb2FkIHRoZSByZXBseSBtZXNzYWdlcyBmcm9tIHRoZSBKU09OIGZpbGUKY29uc3QgbG9hZFJlcGx5TWVzc2FnZXMgPSAoKSA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2RhdGFiYXNlJywgJ2NoYXRib3QuanNvbicpOwogICAgY29uc3QgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgJ3V0ZjgnKTsKICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpOwogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBsb2FkaW5nIGNoYXRib3QgcmVzcG9uc2VzOicsIGVycm9yLm1lc3NhZ2UpOwogICAgcmV0dXJuIHt9OyAvLyBSZXR1cm4gYW4gZW1wdHkgb2JqZWN0IGlmIHRoZXJlIGlzIGFuIGVycm9yCiAgfQp9OwoKLy8gVHJhY2sgdGhlIHRpbWUgb2YgdGhlIGxhc3QgcmVzcG9uc2UgdG8gZW5mb3JjZSByYXRlLWxpbWl0aW5nCmxldCBsYXN0UmVwbHlUaW1lID0gMDsKCi8vIERlZmluZSB0aGUgbWluaW11bSBkZWxheSAoaW4gbWlsbGlzZWNvbmRzKSBiZXR3ZWVuIHJlcGxpZXMgKGUuZy4sIDUgc2Vjb25kcykKY29uc3QgTUlOX1JFUExZX0RFTEFZID0gNTAwMDsKCi8vIEZ1bmN0aW9uIHRvIGZpbmQgYSBtYXRjaGluZyB0ZXh0IHJlcGx5IGJhc2VkIG9uIHRoZSBtZXNzYWdlCmNvbnN0IGdldFJlcGx5TWVzc2FnZSA9IChtZXNzYWdlVGV4dCwgcmVwbHlNZXNzYWdlcykgPT4gewogIC8vIENvbnZlcnQgdGhlIG1lc3NhZ2UgdG8gbG93ZXJjYXNlIGFuZCBzcGxpdCBpdCBpbnRvIHdvcmRzCiAgY29uc3Qgd29yZHMgPSBtZXNzYWdlVGV4dC50b0xvd2VyQ2FzZSgpLnNwbGl0KC9ccysvKTsKCiAgLy8gQ2hlY2sgaWYgYW55IG9mIHRoZSB3b3JkcyBtYXRjaCBhIGtleXdvcmQgaW4gdGhlIHJlcGx5TWVzc2FnZXMgb2JqZWN0CiAgZm9yIChjb25zdCB3b3JkIG9mIHdvcmRzKSB7CiAgICBpZiAocmVwbHlNZXNzYWdlc1t3b3JkXSkgewogICAgICByZXR1cm4gcmVwbHlNZXNzYWdlc1t3b3JkXTsgLy8gUmV0dXJuIHRoZSBtYXRjaGluZyByZXBseQogICAgfQogIH0KCiAgcmV0dXJuIG51bGw7IC8vIFJldHVybiBudWxsIGlmIG5vIG1hdGNoIGlzIGZvdW5kCn07CgovLyBMaXN0ZW4gZm9yIGluY29taW5nIG1lc3NhZ2VzIHdoZW4gQ0hBVF9CT1QgaXMgZW5hYmxlZAppZiAoY29uZi5DSEFUX0JPVCA9PT0gJ3llcycpIHsKICBjb25zb2xlLmxvZygnQ0hBVF9CT1QgaXMgZW5hYmxlZC4gTGlzdGVuaW5nIGZvciBtZXNzYWdlcy4uLicpOwogIAogIHprLmV2Lm9uKCdtZXNzYWdlcy51cHNlcnQnLCBhc3luYyAoZXZlbnQpID0+IHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgbWVzc2FnZXMgfSA9IGV2ZW50OwogICAgICAKICAgICAgLy8gTG9hZCB0aGUgcmVwbGllcyBmcm9tIHRoZSBKU09OIGZpbGUKICAgICAgY29uc3QgcmVwbHlNZXNzYWdlcyA9IGxvYWRSZXBseU1lc3NhZ2VzKCk7CgogICAgICAvLyBJdGVyYXRlIG92ZXIgaW5jb21pbmcgbWVzc2FnZXMKICAgICAgZm9yIChjb25zdCBtZXNzYWdlIG9mIG1lc3NhZ2VzKSB7CiAgICAgICAgaWYgKCFtZXNzYWdlLmtleSB8fCAhbWVzc2FnZS5rZXkucmVtb3RlSmlkKSB7CiAgICAgICAgICBjb250aW51ZTsgLy8gU2tpcCBpZiB0aGVyZSdzIG5vIHJlbW90ZUppZAogICAgICAgIH0KCiAgICAgICAgY29uc3QgbWVzc2FnZVRleHQgPSBtZXNzYWdlLm1lc3NhZ2U/LmNvbnZlcnNhdGlvbiB8fCBtZXNzYWdlLm1lc3NhZ2U/LmV4dGVuZGVkVGV4dE1lc3NhZ2U/LnRleHQgfHwgJyc7CiAgICAgICAgY29uc3QgcmVwbHlNZXNzYWdlID0gZ2V0UmVwbHlNZXNzYWdlKG1lc3NhZ2VUZXh0LCByZXBseU1lc3NhZ2VzKTsKCiAgICAgICAgLy8gRW5zdXJlIHdlIGRvbid0IHNlbmQgcmVwbGllcyB0b28gZnJlcXVlbnRseQogICAgICAgIGNvbnN0IGN1cnJlbnRUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICBpZiAoY3VycmVudFRpbWUgLSBsYXN0UmVwbHlUaW1lIDwgTUlOX1JFUExZX0RFTEFZKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnUmF0ZSBsaW1pdCBhcHBsaWVkLiBTa2lwcGluZyByZXBseS4nKTsKICAgICAgICAgIGNvbnRpbnVlOyAvLyBTa2lwIHRoaXMgcmVwbHkgaWYgdGhlIGRlbGF5IGhhc24ndCBwYXNzZWQKICAgICAgICB9CgogICAgICAgIGlmIChyZXBseU1lc3NhZ2UpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIFNlbmQgdGhlIGNvcnJlc3BvbmRpbmcgdGV4dCByZXBseQogICAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShtZXNzYWdlLmtleS5yZW1vdGVKaWQsIHsKICAgICAgICAgICAgICB0ZXh0OiByZXBseU1lc3NhZ2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBUZXh0IHJlcGx5IHNlbnQ6ICR7cmVwbHlNZXNzYWdlfWApOwoKICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBsYXN0IHJlcGx5IHRpbWUKICAgICAgICAgICAgbGFzdFJlcGx5VGltZSA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3Igc2VuZGluZyB0ZXh0IHJlcGx5OiAke2Vycm9yLm1lc3NhZ2V9YCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdObyBtYXRjaGluZyBrZXl3b3JkIGRldGVjdGVkLiBTa2lwcGluZyBtZXNzYWdlLicpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2FpdCBmb3IgYSBicmllZiBtb21lbnQgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIG5leHQgbWVzc2FnZSAoMyBzZWNvbmRzIGRlbGF5KQogICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDMwMDApKTsKICAgICAgfQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gbWVzc2FnZSBwcm9jZXNzaW5nOicsIGVycm9yLm1lc3NhZ2UpOwogICAgfQogIH0pOwp9Ci8vIEFVVE9fUkVBQ1Q6IFJlYWN0IHRvIG1lc3NhZ2VzIHdpdGggcmFuZG9tIGVtb2ppIGlmIGVuYWJsZWQuCmlmIChjb25mLkFVVE9fUkVBQ1QgPT09ICJ5ZXMiKSB7CiAgemsuZXYub24oIm1lc3NhZ2VzLnVwc2VydCIsIGFzeW5jIG0gPT4gewogICAgY29uc3QgeyBtZXNzYWdlcyB9ID0gbTsKCiAgICAvLyBMb2FkIGVtb2ppcyBmcm9tIHRoZSBKU09OIGZpbGUKICAgIGNvbnN0IGVtb2ppRmlsZVBhdGggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnZGF0YWJhc2UnLCAnZW1vamlzLmpzb24nKTsKICAgIGxldCBlbW9qaXMgPSBbXTsKICAgIAogICAgdHJ5IHsKICAgICAgLy8gUmVhZCB0aGUgZW1vamlzIGZyb20gdGhlIGZpbGUKICAgICAgY29uc3QgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhlbW9qaUZpbGVQYXRoLCAndXRmOCcpOwogICAgICBlbW9qaXMgPSBKU09OLnBhcnNlKGRhdGEpOyAvLyBQYXJzZSB0aGUgSlNPTiBkYXRhIGludG8gYW4gYXJyYXkKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHJlYWRpbmcgZW1vamlzIGZpbGU6JywgZXJyb3IpOwogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gUHJvY2VzcyBlYWNoIG1lc3NhZ2UKICAgIGZvciAoY29uc3QgbWVzc2FnZSBvZiBtZXNzYWdlcykgewogICAgICBpZiAoIW1lc3NhZ2Uua2V5LmZyb21NZSkgewogICAgICAgIGNvbnN0IHJhbmRvbUVtb2ppID0gZW1vamlzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGVtb2ppcy5sZW5ndGgpXTsKICAgICAgICAKICAgICAgICAvLyBSZWFjdCB0byB0aGUgbWVzc2FnZSB3aXRoIGEgcmFuZG9tIGVtb2ppCiAgICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2UobWVzc2FnZS5rZXkucmVtb3RlSmlkLCB7CiAgICAgICAgICByZWFjdDogewogICAgICAgICAgICB0ZXh0OiByYW5kb21FbW9qaSwKICAgICAgICAgICAga2V5OiBtZXNzYWdlLmtleQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSk7Cn0KY29uc3QgZGVsYXkgPSBtcyA9PiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCi8vIFRyYWNrIHRoZSBsYXN0IHJlYWN0aW9uIHRpbWUgdG8gcHJldmVudCBvdmVyZmxvdwpsZXQgbGFzdFJlYWN0aW9uVGltZSA9IDA7CgovLyBBcnJheSBvZiBsb3ZlIGVtb2ppcyB0byByZWFjdCB3aXRoCmNvbnN0IGxvdmVFbW9qaXMgPSBbJ/4PIiwg+v2WIiwg+v2YIiwg+v2dIiwg+v2TIiwg+v2MIiwg+v2VIiwg+v8OIiwg+v0lIiwg+v2lIiwg+v2vIiwgJygiLCAi/x8iLCAi/wgiLCAioSIsIPo9jiIsIPo8ACIsIPo9USIsIPo8iSIsIPo8iiIsIPo+hCIsIPo9fSIsIPo9+CIsIAogIPo9gCIsIPo+iyIsIPo9qyIsIPo8QCIsIPo8tiIsIPo8pyIsIPo8uCIsIPo8pCIsIPo8xiIsIPo8xSIsIPo8DSIsIPo8DiIsIPo8DyIsIPo8riIsIPo8siIsIPo9qiIsIAogIPo8/w8iLCAi/0ciLCAi/V8iLCAi/8MiLCAi/7QiLCAi/7YiLCAi/8QiLCAi/w8iLCAi/f4PIiwg+v/zIiwg+v9/Iiwg+v9/Iiwg+v9CIiwg+v97Iiwg+v93Iiwg+v94IiwgCiAg+v9DIiwg+v9+Iiwg+v+vIiwgI/MiLCAi/4EiLCAi/4giLCAi/6giLCAi/zsiLCAi/zgiLCAi/zoiLCAi/zkiLCAi/zwiLCAi/x4iLCAi/x0iLCAi/xwiLCAi/xkiLCAKICAi/xoiLCAi/0AiLCAi/zEiLCAi/0MiLCAi/0IiLCAi/z4iLCAi/QkiLCAi/Q0iLCAi/5MiLCAi/4QiLCAi/4siLCAi/6ciLCAi/5giLCAi/6giLCAi/6EiLCAi/QkiLCAKICAi/QUiLCAi/QYiLCAi/RMiLCAi/SIiLCAi/QoiLCAi/SAiLCAi/R8iLCAi/SEiLCAi/5EiLCAi/RkiLCAi/4AiLCAi/SwiLCAi/5UiLCAi/5YiLCAi/T4iLCAi/RUiLCAKICAi/QgiLCAi/QciLCAi/T4iXTsKCmlmIChjb25mLkFVVE9fTElLRV9TVEFUVVMgPT09ICJ5ZXMiKSB7CiAgICBjb25zb2xlLmxvZygiQVVUT19MSUtFX1NUQVRVUyBpcyBlbmFibGVkLiBMaXN0ZW5pbmcgZm9yIHN0YXR1cyB1cGRhdGVzLi4uIik7CgogICAgemsuZXYub24oIm1lc3NhZ2VzLnVwc2VydCIsIGFzeW5jIChtKSA9PiB7CiAgICAgICAgY29uc3QgeyBtZXNzYWdlcyB9ID0gbTsKCiAgICAgICAgZm9yIChjb25zdCBtZXNzYWdlIG9mIG1lc3NhZ2VzKSB7CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBtZXNzYWdlIGlzIGEgc3RhdHVzIHVwZGF0ZQogICAgICAgICAgICBpZiAobWVzc2FnZS5rZXkgJiYgbWVzc2FnZS5rZXkucmVtb3RlSmlkID09PSAic3RhdHVzQGJyb2FkY2FzdCIpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZXRlY3RlZCBzdGF0dXMgdXBkYXRlIGZyb206IiwgbWVzc2FnZS5rZXkucmVtb3RlSmlkKTsKCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhyb3R0bGluZyBieSBjaGVja2luZyB0aGUgbGFzdCByZWFjdGlvbiB0aW1lCiAgICAgICAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgaWYgKG5vdyAtIGxhc3RSZWFjdGlvblRpbWUgPCA1MDAwKSB7ICAvLyA1LXNlY29uZCBpbnRlcnZhbAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJUaHJvdHRsaW5nIHJlYWN0aW9ucyB0byBwcmV2ZW50IG92ZXJmbG93LiIpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGJvdCB1c2VyIElEIGlzIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgY29uc3QgaGFucyA9IHprLnVzZXIgJiYgemsudXNlci5pZCA/IHprLnVzZXIuaWQuc3BsaXQoIjoiKVswXSArICJAcy53aGF0c2FwcC5uZXQiIDogbnVsbDsKICAgICAgICAgICAgICAgIGlmICghaGFucykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJCb3QncyB1c2VyIElEIG5vdCBhdmFpbGFibGUuIFNraXBwaW5nIHJlYWN0aW9uLiIpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNlbGVjdCBhIHJhbmRvbSBsb3ZlIGVtb2ppCiAgICAgICAgICAgICAgICBjb25zdCByYW5kb21Mb3ZlRW1vamkgPSBsb3ZlRW1vamlzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxvdmVFbW9qaXMubGVuZ3RoKV07CgogICAgICAgICAgICAgICAgLy8gUmVhY3QgdG8gdGhlIHN0YXR1cyB3aXRoIHRoZSBzZWxlY3RlZCBsb3ZlIGVtb2ppCiAgICAgICAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShtZXNzYWdlLmtleS5yZW1vdGVKaWQsIHsKICAgICAgICAgICAgICAgICAgICByZWFjdDogewogICAgICAgICAgICAgICAgICAgICAgICBrZXk6IG1lc3NhZ2Uua2V5LAogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiByYW5kb21Mb3ZlRW1vamksIC8vIFJlYWN0aW9uIGVtb2ppCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBzdGF0dXNKaWRMaXN0OiBbbWVzc2FnZS5rZXkucGFydGljaXBhbnRdLCAvLyBBZGQgb3RoZXIgcGFydGljaXBhbnRzIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gTG9nIHN1Y2Nlc3NmdWwgcmVhY3Rpb24gYW5kIHVwZGF0ZSB0aGUgbGFzdCByZWFjdGlvbiB0aW1lCiAgICAgICAgICAgICAgICBsYXN0UmVhY3Rpb25UaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTdWNjZXNzZnVsbHkgcmVhY3RlZCB0byBzdGF0dXMgdXBkYXRlIGJ5ICR7bWVzc2FnZS5rZXkucmVtb3RlSmlkfSB3aXRoICR7cmFuZG9tTG92ZUVtb2ppfWApOwoKICAgICAgICAgICAgICAgIC8vIERlbGF5IHRvIGF2b2lkIHJhcGlkIHJlYWN0aW9ucwogICAgICAgICAgICAgICAgYXdhaXQgZGVsYXkoMjAwMCk7IC8vIDItc2Vjb25kIGRlbGF5IGJldHdlZW4gcmVhY3Rpb25zCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKfQoKICAgIHprLmV2Lm9uKCJtZXNzYWdlcy51cHNlcnQiLCBhc3luYyBtID0+IHsKICAgICAgY29uc3QgewogICAgICAgIG1lc3NhZ2VzCiAgICAgIH0gPSBtOwogICAgICBjb25zdCBtcyA9IG1lc3NhZ2VzWzBdOwogICAgICBpZiAoIW1zLm1lc3NhZ2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgZGVjb2RlSmlkID0gamlkID0+IHsKICAgICAgICBpZiAoIWppZCkgewogICAgICAgICAgcmV0dXJuIGppZDsKICAgICAgICB9CiAgICAgICAgaWYgKC86XGQrQC9naS50ZXN0KGppZCkpIHsKICAgICAgICAgIDA7CiAgICAgICAgICBsZXQgZGVjb2RlID0gYmFpbGV5c18xLmppZERlY29kZShqaWQpIHx8IHt9OwogICAgICAgICAgcmV0dXJuIGRlY29kZS51c2VyICYmIGRlY29kZS5zZXJ2ZXIgJiYgZGVjb2RlLnVzZXIgKyAnQCcgKyBkZWNvZGUuc2VydmVyIHx8IGppZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGppZDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIDA7CiAgICAgIHZhciBtdHlwZSA9IGJhaWxleXNfMS5nZXRDb250ZW50VHlwZShtcy5tZXNzYWdlKTsKICAgICAgdmFyIHRleHRlID0gbXR5cGUgPT0gImNvbnZlcnNhdGlvbiIgPyBtcy5tZXNzYWdlLmNvbnZlcnNhdGlvbiA6IG10eXBlID09ICJpbWFnZU1lc3NhZ2UiID8gbXMubWVzc2FnZS5pbWFnZU1lc3NhZ2U/LmNhcHRpb24gOiBtdHlwZSA9PSAidmlkZW9NZXNzYWdlIiA/IG1zLm1lc3NhZ2UudmlkZW9NZXNzYWdlPy5jYXB0aW9uIDogbXR5cGUgPT0gImV4dGVuZGVkVGV4dE1lc3NhZ2UiID8gbXMubWVzc2FnZT8uZXh0ZW5kZWRUZXh0TWVzc2FnZT8udGV4dCA6IG10eXBlID09ICJidXR0b25zUmVzcG9uc2VNZXNzYWdlIiA/IG1zPy5tZXNzYWdlPy5idXR0b25zUmVzcG9uc2VNZXNzYWdlPy5zZWxlY3RlZEJ1dHRvbklkIDogbXR5cGUgPT0gImxpc3RSZXNwb25zZU1lc3NhZ2UiID8gbXMubWVzc2FnZT8ubGlzdFJlc3BvbnNlTWVzc2FnZT8uc2luZ2xlU2VsZWN0UmVwbHk/LnNlbGVjdGVkUm93SWQgOiBtdHlwZSA9PSAibWVzc2FnZUNvbnRleHRJbmZvIiA/IG1zPy5tZXNzYWdlPy5idXR0b25zUmVzcG9uc2VNZXNzYWdlPy5zZWxlY3RlZEJ1dHRvbklkIHx8IG1zLm1lc3NhZ2U/Lmxpc3RSZXNwb25zZU1lc3NhZ2U/LnNpbmdsZVNlbGVjdFJlcGx5Py5zZWxlY3RlZFJvd0lkIHx8IG1zLnRleHQgOiAiIjsKICAgICAgdmFyIG9yaWdpbmVNZXNzYWdlID0gbXMua2V5LnJlbW90ZUppZDsKICAgICAgdmFyIGlkQm90ID0gZGVjb2RlSmlkKHprLnVzZXIuaWQpOwogICAgICB2YXIgc2VydkJvdCA9IGlkQm90LnNwbGl0KCdAJylbMF07CiAgICAgIC8qIGNvbnN0IGRqPScyMjU1OTc2MzQ0Nyc7CiAgICAgICBjb25zdCBkajI9JzIyNTAxNDMzNDMzNTcnOwogICAgICAgY29uc3QgbHVmZnk9JzIyODkxNzMzMzAwJyovCiAgICAgIC8qICB2YXIgc3VwZXJVc2VyPVtzZXJ2Qm90LGRqLGRqMixsdWZmeV0ubWFwKChzKT0+cy5yZXBsYWNlKC9bXjAtOV0vZykrIkBzLndoYXRzYXBwLm5ldCIpLmluY2x1ZGVzKGF1dGV1ck1lc3NhZ2UpOwogICAgICAgIHZhciBkZXYgPVtkaixkajIsbHVmZnldLm1hcCgodCk9PnQucmVwbGFjZSgvW14wLTldL2cpKyJAcy53aGF0c2FwcC5uZXQiKS5pbmNsdWRlcyhhdXRldXJNZXNzYWdlKTsqLwogICAgICBjb25zdCB2ZXJpZkdyb3VwZSA9IG9yaWdpbmVNZXNzYWdlPy5lbmRzV2l0aCgiQGcudXMiKTsKICAgICAgdmFyIGluZm9zR3JvdXBlID0gdmVyaWZHcm91cGUgPyBhd2FpdCB6ay5ncm91cE1ldGFkYXRhKG9yaWdpbmVNZXNzYWdlKSA6ICIiOwogICAgICB2YXIgbm9tR3JvdXBlID0gdmVyaWZHcm91cGUgPyBpbmZvc0dyb3VwZS5zdWJqZWN0IDogIiI7CiAgICAgIHZhciBtc2dSZXBvbmR1ID0gbXMubWVzc2FnZS5leHRlbmRlZFRleHRNZXNzYWdlPy5jb250ZXh0SW5mbz8ucXVvdGVkTWVzc2FnZTsKICAgICAgdmFyIGF1dGV1ck1zZ1JlcG9uZHUgPSBkZWNvZGVKaWQobXMubWVzc2FnZT8uZXh0ZW5kZWRUZXh0TWVzc2FnZT8uY29udGV4dEluZm8/LnBhcnRpY2lwYW50KTsKICAgICAgLy9tcy5tZXNzYWdlLmV4dGVuZGVkVGV4dE1lc3NhZ2U/LmNvbnRleHRJbmZvPy5tZW50aW9uZWRKaWQKICAgICAgLy8gbXMubWVzc2FnZS5leHRlbmRlZFRleHRNZXNzYWdlPy5jb250ZXh0SW5mbz8ucXVvdGVkTWVzc2FnZS4KICAgICAgdmFyIGF1dGV1ck1lc3NhZ2UgPSB2ZXJpZkdyb3VwZSA/IG1zLmtleS5wYXJ0aWNpcGFudCA/IG1zLmtleS5wYXJ0aWNpcGFudCA6IG1zLnBhcnRpY2lwYW50IDogb3JpZ2luZU1lc3NhZ2U7CiAgICAgIGlmIChtcy5rZXkuZnJvbU1lKSB7CiAgICAgICAgYXV0ZXVyTWVzc2FnZSA9IGlkQm90OwogICAgICB9CiAgICAgIHZhciBtZW1icmVHcm91cGUgPSB2ZXJpZkdyb3VwZSA/IG1zLmtleS5wYXJ0aWNpcGFudCA6ICcnOwogICAgICBjb25zdCB7CiAgICAgICAgZ2V0QWxsU3Vkb051bWJlcnMKICAgICAgfSA9IHJlcXVpcmUoIi4vYmRkL3N1ZG8iKTsKICAgICAgY29uc3Qgbm9tQXV0ZXVyTWVzc2FnZSA9IG1zLnB1c2hOYW1lOwogICAgICBjb25zdCBzdWRvID0gYXdhaXQgZ2V0QWxsU3Vkb051bWJlcnMoKTsKICAgICAgY29uc3Qgc3VwZXJVc2VyTnVtYmVycyA9IFtzZXJ2Qm90LCAiMjU0NzQ4Mzg3NjE1IiwgJzI1NDExMDE5MDE5NicsICcyNTQ3NDgzODc2MTUnLCAiMjU0Nzk2Mjk5MTU5IiwgJzI1NDc1MjkyNTkzOCcsIGNvbmYuTlVNRVJPX09XTkVSXS5tYXAocyA9PiBzLnJlcGxhY2UoL1teMC05XS9nKSArICJAcy53aGF0c2FwcC5uZXQiKTsKICAgICAgY29uc3QgYWxsQWxsb3dlZE51bWJlcnMgPSBzdXBlclVzZXJOdW1iZXJzLmNvbmNhdChzdWRvKTsKICAgICAgY29uc3Qgc3VwZXJVc2VyID0gYWxsQWxsb3dlZE51bWJlcnMuaW5jbHVkZXMoYXV0ZXVyTWVzc2FnZSk7CiAgICAgIHZhciBkZXYgPSBbJzI1NDExMDE5MDE5NicsICcyNTQ3NDgzODc2MTUnLCAiMjU0Nzk2Mjk5MTU5IiwgJzI1NDc1MjkyNTkzOCddLm1hcCh0ID0+IHQucmVwbGFjZSgvW14wLTldL2cpICsgIkBzLndoYXRzYXBwLm5ldCIpLmluY2x1ZGVzKGF1dGV1ck1lc3NhZ2UpOwogICAgICBmdW5jdGlvbiByZXBvbmRyZShtZXMpIHsKICAgICAgICB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgewogICAgICAgICAgdGV4dDogbWVzCiAgICAgICAgfSwgewogICAgICAgICAgcXVvdGVkOiBtcwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGNvbnNvbGUubG9nKCJcdCBbXVtdLi4ue0ZFTElYLU1EfS4uLltdW10iKTsKICAgICAgY29uc29sZS5sb2coIj09PT09PT09PT09IE5ldyBtZXNzYWdlID09PT09PT09PT09Iik7CiAgICAgIGlmICh2ZXJpZkdyb3VwZSkgewogICAgICAgIGNvbnNvbGUubG9nKCJtZXNzYWdlIHNlbnQgZnJvbSA6ICIgKyBub21Hcm91cGUpOwogICAgICB9CiAgICAgIGNvbnNvbGUubG9nKCJtZXNzYWdlIGZyb20gOiBbIiArIG5vbUF1dGV1ck1lc3NhZ2UgKyAiIDogIiArIGF1dGV1ck1lc3NhZ2Uuc3BsaXQoIkBzLndoYXRzYXBwLm5ldCIpWzBdICsgIiBdIik7CiAgICAgIGNvbnNvbGUubG9nKCJ0eXBlIG9mIG1lc3NhZ2UgOiAiICsgbXR5cGUpOwogICAgICBjb25zb2xlLmxvZygiLS0tLS0tZW5kIG9mIHlvdXIgbWVzc2FnZXMgLS0tLS0tIik7CiAgICAgIGNvbnNvbGUubG9nKHRleHRlKTsKICAgICAgLyoqICAqLwogICAgICBmdW5jdGlvbiBncm91cGVBZG1pbihtZW1icmVHcm91cGUpIHsKICAgICAgICBsZXQgYWRtaW4gPSBbXTsKICAgICAgICBmb3IgKG0gb2YgbWVtYnJlR3JvdXBlKSB7CiAgICAgICAgICBpZiAobS5hZG1pbiA9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgYWRtaW4ucHVzaChtLmlkKTsKICAgICAgICB9CiAgICAgICAgLy8gZWxzZXthZG1pbj0gZmFsc2U7fQogICAgICAgIHJldHVybiBhZG1pbjsKICAgICAgfQogICAgICB2YXIgZXRhdCA9IGNvbmYuRVRBVDsKICAgICAgaWYgKGV0YXQgPT0gMSkgewogICAgICAgIGF3YWl0IHprLnNlbmRQcmVzZW5jZVVwZGF0ZSgiYXZhaWxhYmxlIiwgb3JpZ2luZU1lc3NhZ2UpOwogICAgICB9IGVsc2UgaWYgKGV0YXQgPT0gMikgewogICAgICAgIGF3YWl0IHprLnNlbmRQcmVzZW5jZVVwZGF0ZSgiY29tcG9zaW5nIiwgb3JpZ2luZU1lc3NhZ2UpOwogICAgICB9IGVsc2UgaWYgKGV0YXQgPT0gMykgewogICAgICAgIGF3YWl0IHprLnNlbmRQcmVzZW5jZVVwZGF0ZSgicmVjb3JkaW5nIiwgb3JpZ2luZU1lc3NhZ2UpOwogICAgICB9IGVsc2UgewogICAgICAgIGF3YWl0IHprLnNlbmRQcmVzZW5jZVVwZGF0ZSgidW5hdmFpbGFibGUiLCBvcmlnaW5lTWVzc2FnZSk7CiAgICAgIH0KICAgICAgY29uc3QgbWJyZSA9IHZlcmlmR3JvdXBlID8gYXdhaXQgaW5mb3NHcm91cGUucGFydGljaXBhbnRzIDogJyc7CiAgICAgIC8vICBjb25zdCB2ZXJpZkFkbWluID0gdmVyaWZHcm91cGUgPyBhd2FpdCBtYnJlLmZpbHRlcih2ID0+IHYuYWRtaW4gIT09IG51bGwpLm1hcCh2ID0+IHYuaWQpIDogJycKICAgICAgbGV0IGFkbWlucyA9IHZlcmlmR3JvdXBlID8gZ3JvdXBlQWRtaW4obWJyZSkgOiAnJzsKICAgICAgY29uc3QgdmVyaWZBZG1pbiA9IHZlcmlmR3JvdXBlID8gYWRtaW5zLmluY2x1ZGVzKGF1dGV1ck1lc3NhZ2UpIDogZmFsc2U7CiAgICAgIHZhciB2ZXJpZlpva291QWRtaW4gPSB2ZXJpZkdyb3VwZSA/IGFkbWlucy5pbmNsdWRlcyhpZEJvdCkgOiBmYWxzZTsKICAgICAgLyoqICoqICovCiAgICAgIC8qKiAqKioqKiAqLwogICAgICBjb25zdCBhcmcgPSB0ZXh0ZSA/IHRleHRlLnRyaW0oKS5zcGxpdCgvICsvKS5zbGljZSgxKSA6IG51bGw7CiAgICAgIGNvbnN0IHZlcmlmQ29tID0gdGV4dGUgPyB0ZXh0ZS5zdGFydHNXaXRoKHByZWZpeGUpIDogZmFsc2U7CiAgICAgIGNvbnN0IGNvbSA9IHZlcmlmQ29tID8gdGV4dGUuc2xpY2UoMSkudHJpbSgpLnNwbGl0KC8gKy8pLnNoaWZ0KCkudG9Mb3dlckNhc2UoKSA6IGZhbHNlOwogICAgICBjb25zdCBsaWVuID0gY29uZi5VUkwuc3BsaXQoJywnKTsKCiAgICAgIC8vIFV0aWxpc2VyIHVuZSBib3VjbGUgZm9yLi4ub2YgcG91ciBwYXJjb3VyaXIgbGVzIGxpZW5zCiAgICAgIGZ1bmN0aW9uIG15Ym90cGljKCkgewogICAgICAgIC8vIEfpbulyZXIgdW4gaW5kaWNlIGFs6WF0b2lyZSBlbnRyZSAwIChpbmNsdXMpIGV0IGxhIGxvbmd1ZXVyIGR1IHRhYmxlYXUgKGV4Y2x1cykKICAgICAgICAvLyBH6W7pcmVyIHVuIGluZGljZSBhbOlhdG9pcmUgZW50cmUgMCAoaW5jbHVzKSBldCBsYSBsb25ndWV1ciBkdSB0YWJsZWF1IChleGNsdXMpCiAgICAgICAgY29uc3QgaW5kaWNlQWxlYXRvaXJlID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGllbi5sZW5ndGgpOwogICAgICAgIC8vIFLpY3Vw6XJlciBsZSBsaWVuIGNvcnJlc3BvbmRhbnQg4CBsJ2luZGljZSBhbOlhdG9pcmUKICAgICAgICBjb25zdCBsaWVuQWxlYXRvaXJlID0gbGllbltpbmRpY2VBbGVhdG9pcmVdOwogICAgICAgIHJldHVybiBsaWVuQWxlYXRvaXJlOwogICAgICB9CiAgICAgIHZhciBjb21tYW5kZU9wdGlvbnMgPSB7CiAgICAgICAgc3VwZXJVc2VyLAogICAgICAgIGRldiwKICAgICAgICB2ZXJpZkdyb3VwZSwKICAgICAgICBtYnJlLAogICAgICAgIG1lbWJyZUdyb3VwZSwKICAgICAgICB2ZXJpZkFkbWluLAogICAgICAgIGluZm9zR3JvdXBlLAogICAgICAgIG5vbUdyb3VwZSwKICAgICAgICBhdXRldXJNZXNzYWdlLAogICAgICAgIG5vbUF1dGV1ck1lc3NhZ2UsCiAgICAgICAgaWRCb3QsCiAgICAgICAgdmVyaWZab2tvdUFkbWluLAogICAgICAgIHByZWZpeGUsCiAgICAgICAgYXJnLAogICAgICAgIHJlcG9uZHJlLAogICAgICAgIG10eXBlLAogICAgICAgIGdyb3VwZUFkbWluLAogICAgICAgIG1zZ1JlcG9uZHUsCiAgICAgICAgYXV0ZXVyTXNnUmVwb25kdSwKICAgICAgICBtcywKICAgICAgICBteWJvdHBpYwogICAgICB9OwogICAgICBpZiAob3JpZ2luZU1lc3NhZ2UgPT09ICIxMjAzNjMyNDQ0MzUwOTI5NDZAZy51cyIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gQVVUT19SRUFEX01FU1NBR0VTOiBBdXRvbWF0aWNhbGx5IG1hcmsgbWVzc2FnZXMgYXMgcmVhZCBpZiBlbmFibGVkLgogICAgICBpZiAoY29uZi5BVVRPX1JFQURfTUVTU0FHRVMgPT09ICJ5ZXMiKSB7CiAgICAgICAgemsuZXYub24oIm1lc3NhZ2VzLnVwc2VydCIsIGFzeW5jIG0gPT4gewogICAgICAgICAgY29uc3QgewogICAgICAgICAgICBtZXNzYWdlcwogICAgICAgICAgfSA9IG07CiAgICAgICAgICBmb3IgKGNvbnN0IG1lc3NhZ2Ugb2YgbWVzc2FnZXMpIHsKICAgICAgICAgICAgaWYgKCFtZXNzYWdlLmtleS5mcm9tTWUpIHsKICAgICAgICAgICAgICBhd2FpdCB6ay5yZWFkTWVzc2FnZXMoW21lc3NhZ2Uua2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgLy8gSGFuZGxlIHZpZXdPbmNlIG1lc3NhZ2VzCmlmIChtcy5tZXNzYWdlPy52aWV3T25jZU1lc3NhZ2UgfHwgbXMubWVzc2FnZT8udmlld09uY2VNZXNzYWdlVjIgfHwgbXMubWVzc2FnZT8udmlld09uY2VNZXNzYWdlVjJFeHRlbnNpb24pIHsKICBpZiAoY29uZi5BTlRJX1ZWLnRvTG93ZXJDYXNlKCkgPT09ICJ5ZXMiICYmICFtcy5rZXkuZnJvbU1lKSB7CiAgICBjb25zdCBtZXNzYWdlQ29udGVudCA9IG1zLm1lc3NhZ2VbbXR5cGVdOwoKICAgIC8vIENoZWNrIGlmIHRoZSBtZXNzYWdlIGlzIGFuIGltYWdlCiAgICBpZiAobWVzc2FnZUNvbnRlbnQuaW1hZ2VNZXNzYWdlKSB7CiAgICAgIGNvbnN0IGltYWdlVXJsID0gYXdhaXQgemsuZG93bmxvYWRBbmRTYXZlTWVkaWFNZXNzYWdlKG1lc3NhZ2VDb250ZW50LmltYWdlTWVzc2FnZSk7CiAgICAgIGNvbnN0IGltYWdlQ2FwdGlvbiA9IG1lc3NhZ2VDb250ZW50LmltYWdlTWVzc2FnZS5jYXB0aW9uOwoKICAgICAgY29uc3QgaW1hZ2VNZXNzYWdlID0gewogICAgICAgIGltYWdlOiB7IHVybDogaW1hZ2VVcmwgfSwKICAgICAgICBjYXB0aW9uOiBpbWFnZUNhcHRpb24KICAgICAgfTsKCiAgICAgIGNvbnN0IHF1b3RlZE1lc3NhZ2UgPSB7IHF1b3RlZDogbXMgfTsKICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2UoaWRCb3QsIGltYWdlTWVzc2FnZSwgcXVvdGVkTWVzc2FnZSk7CiAgICB9IAogICAgLy8gQ2hlY2sgaWYgdGhlIG1lc3NhZ2UgaXMgYSB2aWRlbwogICAgZWxzZSBpZiAobWVzc2FnZUNvbnRlbnQudmlkZW9NZXNzYWdlKSB7CiAgICAgIGNvbnN0IHZpZGVvVXJsID0gYXdhaXQgemsuZG93bmxvYWRBbmRTYXZlTWVkaWFNZXNzYWdlKG1lc3NhZ2VDb250ZW50LnZpZGVvTWVzc2FnZSk7CiAgICAgIGNvbnN0IHZpZGVvQ2FwdGlvbiA9IG1lc3NhZ2VDb250ZW50LnZpZGVvTWVzc2FnZS5jYXB0aW9uOwoKICAgICAgY29uc3QgdmlkZW9NZXNzYWdlID0gewogICAgICAgIHZpZGVvOiB7IHVybDogdmlkZW9VcmwgfSwKICAgICAgICBjYXB0aW9uOiB2aWRlb0NhcHRpb24KICAgICAgfTsKCiAgICAgIGNvbnN0IHF1b3RlZE1lc3NhZ2UgPSB7IHF1b3RlZDogbXMgfTsKICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2UoaWRCb3QsIHZpZGVvTWVzc2FnZSwgcXVvdGVkTWVzc2FnZSk7CiAgICB9IAogICAgLy8gQ2hlY2sgaWYgdGhlIG1lc3NhZ2UgaXMgYXVkaW8KICAgIGVsc2UgaWYgKG1lc3NhZ2VDb250ZW50LmF1ZGlvTWVzc2FnZSkgewogICAgICBjb25zdCBhdWRpb1VybCA9IGF3YWl0IHprLmRvd25sb2FkQW5kU2F2ZU1lZGlhTWVzc2FnZShtZXNzYWdlQ29udGVudC5hdWRpb01lc3NhZ2UpOwoKICAgICAgY29uc3QgYXVkaW9NZXNzYWdlID0gewogICAgICAgIGF1ZGlvOiB7IHVybDogYXVkaW9VcmwgfSwKICAgICAgICBteW1ldHlwZTogImF1ZGlvL21wNCIKICAgICAgfTsKCiAgICAgIGNvbnN0IHF1b3RlZE1lc3NhZ2UgPSB7IHF1b3RlZDogbXMsIHB0dDogZmFsc2UgfTsKICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2UoaWRCb3QsIGF1ZGlvTWVzc2FnZSwgcXVvdGVkTWVzc2FnZSk7CiAgICB9CiAgfQp9ICAgCiAgICAgIC8vIEhhbmRsZSBtZWRpYSBtZXNzYWdlcyBsaWtlIGltYWdlcywgYXVkaW8sIHZpZGVvLCBzdGlja2VycywgYW5kIGRvY3VtZW50cwppZiAobXMubWVzc2FnZT8uaW1hZ2VNZXNzYWdlIHx8IG1zLm1lc3NhZ2U/LmF1ZGlvTWVzc2FnZSB8fCBtcy5tZXNzYWdlPy52aWRlb01lc3NhZ2UgfHwgbXMubWVzc2FnZT8uc3RpY2tlck1lc3NhZ2UgfHwgbXMubWVzc2FnZT8uZG9jdW1lbnRNZXNzYWdlKSB7CiAgbGV0IGlzU3BhbTsKCiAgLy8gQ2hlY2sgaWYgYW50aXNwYW0gZGF0YSBleGlzdHMgaW4gY2FjaGUKICBpZiAobXMuaGFzKCJhbnRpc3BhbSIpKSB7CiAgICBpc1NwYW0gPSBtcy5nZXQoImFudGlzcGFtIikuaW5jbHVkZXMob3JpZ2luZU1lc3NhZ2UpOwogIH0gZWxzZSB7CiAgICBjb25zdCBhbnRpc3BhbUxpc3QgPSBhd2FpdCBhbnRpc3BhbUZ1bmN0aW9ucygpOwogICAgaXNTcGFtID0gYW50aXNwYW1MaXN0LmluY2x1ZGVzKG9yaWdpbmVNZXNzYWdlKTsKICAgIG1zLnNldCgiYW50aXNwYW0iLCBhbnRpc3BhbUxpc3QpOwogIH0KCiAgLy8gSWYgdGhlIG1lc3NhZ2UgaXMgY29uc2lkZXJlZCBzcGFtLCBoYW5kbGUgaXQKICBpZiAodmVyaWZHcm91cGUgJiYgaXNTcGFtICYmICFzdXBlclVzZXIgJiYgIXZlcmlmQWRtaW4pIHsKICAgIGNvbnNvbGUud2FybigiLS0tLS0tLS0tLS0tLS0tLS0tTWVkaWEtLS0tLS1zZW50LS0tLS0tLS0tLS0tLS0tLS0tLS0iKTsKCiAgICAvLyBSZXRyaWV2ZSB0aGUgbGlzdCBvZiBzcGFtbWVycyBmb3IgYSBnaXZlbiB1c2VyCiAgICBjb25zdCBzcGFtTGlzdCA9IHNwYW1DYWNoZS5nZXQoYXV0ZXVyTWVzc2FnZSArICdfJyArIG9yaWdpbmVNZXNzYWdlKTsKICAgIGlmIChzcGFtTGlzdCkgewogICAgICBpZiAoc3BhbUxpc3QubGVuZ3RoID49IDQpIHsKICAgICAgICBzcGFtTGlzdC5wdXNoKG1zLmtleSk7CgogICAgICAgIC8vIERlbGV0ZSBhbGwgc3BhbSBtZXNzYWdlcyBmcm9tIHRoZSBncm91cAogICAgICAgIHNwYW1MaXN0LmZvckVhY2goc3BhbUtleSA9PiB7CiAgICAgICAgICBjb25zdCBkZWxldGVNZXNzYWdlID0geyBkZWxldGU6IHNwYW1LZXkgfTsKICAgICAgICAgIHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCBkZWxldGVNZXNzYWdlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gUmVtb3ZlIHRoZSB1c2VyIGZyb20gdGhlIGdyb3VwIGFuZCBzZW5kIGEgbm90aWZpY2F0aW9uCiAgICAgICAgemsuZ3JvdXBQYXJ0aWNpcGFudHNVcGRhdGUob3JpZ2luZU1lc3NhZ2UsIFthdXRldXJNZXNzYWdlXSwgInJlbW92ZSIpLnRoZW4oKCkgPT4gewogICAgICAgICAgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsKICAgICAgICAgICAgdGV4dDogJ0AnICsgYXV0ZXVyTWVzc2FnZS5zcGxpdCgnQCcpWzBdICsgIiByZW1vdmVkIGJlY2F1c2Ugb2Ygc3BhbW1pbmcgaW4gZ3JvdXAiLAogICAgICAgICAgICBtZW50aW9uczogW2F1dGV1ck1lc3NhZ2VdCiAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChlcnIgPT4gY29uc29sZS5sb2coZXJyKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQWRkIHRoZSBjdXJyZW50IG1lc3NhZ2UgdG8gdGhlIHNwYW0gbGlzdAogICAgICAgIHNwYW1MaXN0LnB1c2gobXMua2V5KTsKICAgICAgICBzcGFtQ2FjaGUuc2V0KGF1dGV1ck1lc3NhZ2UgKyAnXycgKyBvcmlnaW5lTWVzc2FnZSwgc3BhbUxpc3QsIDEyMCk7ICAvLyBLZWVwIGZvciAxMjAgc2Vjb25kcwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBJZiBubyBzcGFtIGxpc3QgZXhpc3RzLCBjcmVhdGUgYSBuZXcgb25lCiAgICAgIHNwYW1DYWNoZS5zZXQoYXV0ZXVyTWVzc2FnZSArICdfJyArIG9yaWdpbmVNZXNzYWdlLCBbbXMua2V5XSk7CiAgICB9CiAgfQp9CgogICAgICAvKiogKioqKioqIGdlc3Rpb24gYXV0by1zdGF0dXMgICovCiAgICAgIC8vIEF1dG8gUmVhZCBTdGF0dXMgLSBBdXRvbWF0aWNhbGx5IHJlYWQgc3RhdHVzIG1lc3NhZ2VzCiAgICAgIGlmIChtcy5rZXkgJiYgbXMua2V5LnJlbW90ZUppZCA9PT0gInN0YXR1c0Bicm9hZGNhc3QiICYmIGNvbmYuQVVUT19SRUFEX1NUQVRVUyA9PT0gInllcyIpIHsKICAgICAgICBhd2FpdCB6ay5yZWFkTWVzc2FnZXMoW21zLmtleV0pOwogICAgICB9CgogICAgICAvLyBBTlRJTElOSyBmZWF0dXJlOiBEZXRlY3QgZ3JvdXAgbGlua3MgYW5kIHRha2UgYWN0aW9ucwppZiAoY29uZi5BTlRJTElOSyA9PT0gInllcyIpIHsKICB6ay5ldi5vbigibWVzc2FnZXMudXBzZXJ0IiwgYXN5bmMgKG0pID0+IHsKICAgIGNvbnN0IHsgbWVzc2FnZXMgfSA9IG07CiAgICBjb25zdCBtcyA9IG1lc3NhZ2VzWzBdOwogICAgaWYgKCFtcy5tZXNzYWdlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBFeHRyYWN0IG1lc3NhZ2UgY29udGVudAogICAgY29uc3QgdGV4dGUgPSBtcy5tZXNzYWdlLmNvbnZlcnNhdGlvbiB8fCBtcy5tZXNzYWdlLmV4dGVuZGVkVGV4dE1lc3NhZ2U/LnRleHQgfHwgIiI7CiAgICBjb25zdCBtZXNzYWdlS2V5ID0gbXMua2V5OwogICAgY29uc3QgcmVtb3RlSmlkID0gbWVzc2FnZUtleS5yZW1vdGVKaWQ7CgogICAgLy8gRW5zdXJlIHRoZXJlIGlzIGEgY2hhdCBoaXN0b3J5IHRvIHN0b3JlIHRoZSBtZXNzYWdlCiAgICBpZiAoIXN0b3JlLmNoYXRzW3JlbW90ZUppZF0pIHsKICAgICAgc3RvcmUuY2hhdHNbcmVtb3RlSmlkXSA9IFtdOwogICAgfQogICAgc3RvcmUuY2hhdHNbcmVtb3RlSmlkXS5wdXNoKG1zKTsKCiAgICAvLyBDaGVjayBpZiB0aGUgbWVzc2FnZSBjb250YWlucyBhIFdoYXRzQXBwIGdyb3VwIGxpbmsKICAgIGlmICh0ZXh0ZS5pbmNsdWRlcygiY2hhdC53aGF0c2FwcC5jb20iKSAmJiAhY29uZi5zdXBlclVzZXIuaW5jbHVkZXMobXMua2V5LnBhcnRpY2lwYW50KSAmJgogICAgICBjb25mLnZlcmlmQWRtaW4gJiYgIWNvbmYuZ3JvdXBlQWRtaW4uaW5jbHVkZXMobXMua2V5LnBhcnRpY2lwYW50KSAmJiBtcy5rZXkucmVtb3RlSmlkLmluY2x1ZGVzKCJAZy51cyIpKSB7CgogICAgICAvLyBSZXNwb25kIHRvIHRoZSBtZXNzYWdlCiAgICAgIHJlcG9uZHJlKCJfR3JvdXAgbGluayBkZXRlY3RlZF8iKTsKCiAgICAgIGNvbnN0IHBhcnRpY2lwYW50ID0gbXMua2V5LnBhcnRpY2lwYW50IHx8IG1zLmtleS5yZW1vdGVKaWQ7CiAgICAgIGNvbnN0IGNoYXRJZCA9IG1zLmtleS5yZW1vdGVKaWQ7CgogICAgICAvLyBEZWxldGUgdGhlIG1lc3NhZ2Ugd2l0aCB0aGUgZ3JvdXAgbGluawogICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShjaGF0SWQsIHsKICAgICAgICBkZWxldGU6IHsKICAgICAgICAgIHJlbW90ZUppZDogY2hhdElkLAogICAgICAgICAgZnJvbU1lOiBmYWxzZSwKICAgICAgICAgIGlkOiBtcy5rZXkuaWQsCiAgICAgICAgICBwYXJ0aWNpcGFudDogcGFydGljaXBhbnQsCiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIFJlbW92ZSB0aGUgcGFydGljaXBhbnQgd2hvIHNlbnQgdGhlIGxpbmsKICAgICAgYXdhaXQgemsuZ3JvdXBQYXJ0aWNpcGFudHNVcGRhdGUoY2hhdElkLCBbcGFydGljaXBhbnRdLCAncmVtb3ZlJyk7CgogICAgICAvLyBOb3RpZnkgdGhlIGdyb3VwIGFib3V0IHRoZSBwYXJ0aWNpcGFudCByZW1vdmFsCiAgICAgIGF3YWl0IHprLnNlbmRNZXNzYWdlKGNoYXRJZCwgewogICAgICAgIHRleHQ6IGBSZW1vdmVkIVxuXG5AJHtwYXJ0aWNpcGFudC5zcGxpdCgiQCIpWzBdfSBzZW5kaW5nIGdyb3VwIGxpbmtzIGlzIHByb2hpYml0ZWQhYCwKICAgICAgICBjb250ZXh0SW5mbzogewogICAgICAgICAgbWVudGlvbmVkSmlkOiBbcGFydGljaXBhbnRdCiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAgcXVvdGVkOiBtcwogICAgICB9KTsKICAgIH0KICB9KTsKfQoKICAgICAgLy8gQXV0byBEb3dubG9hZCBhbmQgRm9yd2FyZCBTdGF0dXMgLSBEb3dubG9hZCBhbmQgc2VuZCBzdGF0dXMgbWVzc2FnZXMgdG8gYSBib3QKICAgICAgaWYgKG1zLmtleSAmJiBtcy5rZXkucmVtb3RlSmlkID09PSAnc3RhdHVzQGJyb2FkY2FzdCcgJiYgY29uZi5BVVRPX0RPV05MT0FEX1NUQVRVUyA9PT0gInllcyIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKG1zLm1lc3NhZ2UuZXh0ZW5kZWRUZXh0TWVzc2FnZSkgewogICAgICAgICAgICBjb25zdCBzdFR4dCA9IG1zLm1lc3NhZ2UuZXh0ZW5kZWRUZXh0TWVzc2FnZS50ZXh0OwogICAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShpZEJvdCwgewogICAgICAgICAgICAgIHRleHQ6IHN0VHh0CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBxdW90ZWQ6IG1zCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIGlmIChtcy5tZXNzYWdlLmltYWdlTWVzc2FnZSkgewogICAgICAgICAgICBjb25zdCBzdE1zZyA9IG1zLm1lc3NhZ2UuaW1hZ2VNZXNzYWdlLmNhcHRpb24gfHwgIk5vIGNhcHRpb24iOwogICAgICAgICAgICBjb25zdCBzdEltZyA9IGF3YWl0IHprLmRvd25sb2FkQW5kU2F2ZU1lZGlhTWVzc2FnZShtcy5tZXNzYWdlLmltYWdlTWVzc2FnZSk7CiAgICAgICAgICAgIGF3YWl0IHprLnNlbmRNZXNzYWdlKGlkQm90LCB7CiAgICAgICAgICAgICAgaW1hZ2U6IHsKICAgICAgICAgICAgICAgIHVybDogc3RJbWcKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNhcHRpb246IHN0TXNnCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBxdW90ZWQ6IG1zCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIGlmIChtcy5tZXNzYWdlLnZpZGVvTWVzc2FnZSkgewogICAgICAgICAgICBjb25zdCBzdE1zZyA9IG1zLm1lc3NhZ2UudmlkZW9NZXNzYWdlLmNhcHRpb24gfHwgIk5vIGNhcHRpb24iOwogICAgICAgICAgICBjb25zdCBzdFZpZGVvID0gYXdhaXQgemsuZG93bmxvYWRBbmRTYXZlTWVkaWFNZXNzYWdlKG1zLm1lc3NhZ2UudmlkZW9NZXNzYWdlKTsKICAgICAgICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2UoaWRCb3QsIHsKICAgICAgICAgICAgICB2aWRlbzogewogICAgICAgICAgICAgICAgdXJsOiBzdFZpZGVvCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjYXB0aW9uOiBzdE1zZwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgcXVvdGVkOiBtcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgY29uc29sZS5lcnJvcigiRXJyb3IgaW4gZG93bmxvYWRpbmcgb3Igc2VuZGluZyBzdGF0dXM6IiwgZXJyb3IpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ2hlY2sgdG8gcHJldmVudCBhY3Rpb24gb24gc3BlY2lmaWMgbWVzc2FnZSBvcmlnaW4KICAgICAgaWYgKCFkZXYgJiYgb3JpZ2luZU1lc3NhZ2UgPT09ICIxMjAzNjMxNTg3MDEzMzc5MDRAZy51cyIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tcmFuZy1jb3VudC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgIGlmICh0ZXh0ZSAmJiBhdXRldXJNZXNzYWdlLmVuZHNXaXRoKCJzLndoYXRzYXBwLm5ldCIpKSB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgYWpvdXRlck91TWV0dHJlQUpvdXJVc2VyRGF0YQogICAgICAgIH0gPSByZXF1aXJlKCIuL2JkZC9sZXZlbCIpOwogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCBham91dGVyT3VNZXR0cmVBSm91clVzZXJEYXRhKGF1dGV1ck1lc3NhZ2UpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLyAgIE1lbnRpb25zIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICB0cnkgewogICAgICAgIGlmIChtcy5tZXNzYWdlW210eXBlXS5jb250ZXh0SW5mby5tZW50aW9uZWRKaWQgJiYgKG1zLm1lc3NhZ2VbbXR5cGVdLmNvbnRleHRJbmZvLm1lbnRpb25lZEppZC5pbmNsdWRlcyhpZEJvdCkgfHwgbXMubWVzc2FnZVttdHlwZV0uY29udGV4dEluZm8ubWVudGlvbmVkSmlkLmluY2x1ZGVzKGNvbmYuTlVNRVJPX09XTkVSICsgJ0BzLndoYXRzYXBwLm5ldCcpKSAvKnRleHRlLmluY2x1ZGVzKGlkQm90LnNwbGl0KCdAJylbMF0pIHx8IHRleHRlLmluY2x1ZGVzKGNvbmYuTlVNRVJPX09XTkVSKSovKSB7CiAgICAgICAgICBpZiAob3JpZ2luZU1lc3NhZ2UgPT0gIjEyMDM2MzE1ODcwMTMzNzkwNEBnLnVzIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICA7CiAgICAgICAgICBpZiAoc3VwZXJVc2VyKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdodW1tbScpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgbWJkID0gcmVxdWlyZSgnLi9iZGQvbWVudGlvbicpOwogICAgICAgICAgbGV0IGFsbGRhdGEgPSBhd2FpdCBtYmQucmVjdXBlcmVyVG91dGVzTGVzVmFsZXVycygpOwogICAgICAgICAgbGV0IGRhdGEgPSBhbGxkYXRhWzBdOwogICAgICAgICAgaWYgKGRhdGEuc3RhdHVzID09PSAnbm9uJykgewogICAgICAgICAgICBjb25zb2xlLmxvZygnbWVudGlvbiBwYXMgYWN0aWZzJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBtc2c7CiAgICAgICAgICBpZiAoZGF0YS50eXBlLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICdpbWFnZScpIHsKICAgICAgICAgICAgbXNnID0gewogICAgICAgICAgICAgIGltYWdlOiB7CiAgICAgICAgICAgICAgICB1cmw6IGRhdGEudXJsCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjYXB0aW9uOiBkYXRhLm1lc3NhZ2UKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS50eXBlLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICd2aWRlbycpIHsKICAgICAgICAgICAgbXNnID0gewogICAgICAgICAgICAgIHZpZGVvOiB7CiAgICAgICAgICAgICAgICB1cmw6IGRhdGEudXJsCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjYXB0aW9uOiBkYXRhLm1lc3NhZ2UKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS50eXBlLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICdzdGlja2VyJykgewogICAgICAgICAgICBsZXQgc3RpY2tlck1lc3MgPSBuZXcgU3RpY2tlcihkYXRhLnVybCwgewogICAgICAgICAgICAgIHBhY2s6IGNvbmYuTk9NX09XTkVSLAogICAgICAgICAgICAgIHR5cGU6IFN0aWNrZXJUeXBlcy5GVUxMLAogICAgICAgICAgICAgIGNhdGVnb3JpZXM6IFsi/ykiLCAi/4kiXSwKICAgICAgICAgICAgICBpZDogIjEyMzQ1IiwKICAgICAgICAgICAgICBxdWFsaXR5OiA3MCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAidHJhbnNwYXJlbnQiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBzdGlja2VyQnVmZmVyMiA9IGF3YWl0IHN0aWNrZXJNZXNzLnRvQnVmZmVyKCk7CiAgICAgICAgICAgIG1zZyA9IHsKICAgICAgICAgICAgICBzdGlja2VyOiBzdGlja2VyQnVmZmVyMgogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChkYXRhLnR5cGUudG9Mb2NhbGVMb3dlckNhc2UoKSA9PT0gJ2F1ZGlvJykgewogICAgICAgICAgICBtc2cgPSB7CiAgICAgICAgICAgICAgYXVkaW86IHsKICAgICAgICAgICAgICAgIHVybDogZGF0YS51cmwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1pbWV0eXBlOiAnYXVkaW8vbXA0JwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIG1zZywgewogICAgICAgICAgICBxdW90ZWQ6IG1zCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7fQogICAgICB0cnkgewogICAgICAgIGNvbnN0IGJvdE1zZyA9IG1zLmtleT8uaWQ/LnN0YXJ0c1dpdGgoJ0JBRVMnKSAmJiBtcy5rZXk/LmlkPy5sZW5ndGggPT09IDE2OwogICAgICAgIGNvbnN0IGJhaWxleXNNc2cgPSBtcy5rZXk/LmlkPy5zdGFydHNXaXRoKCdCQUU1JykgJiYgbXMua2V5Py5pZD8ubGVuZ3RoID09PSAxNjsKICAgICAgICBpZiAoYm90TXNnIHx8IGJhaWxleXNNc2cpIHsKICAgICAgICAgIGlmIChtdHlwZSA9PT0gJ3JlYWN0aW9uTWVzc2FnZScpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0plIG5lIHJlYWdpcyBwYXMgYXUgcmVhY3Rpb25zJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIDsKICAgICAgICAgIGNvbnN0IGFudGlib3RhY3RpdmVyID0gYXdhaXQgYXRidmVyaWZpZXJFdGF0SmlkKG9yaWdpbmVNZXNzYWdlKTsKICAgICAgICAgIGlmICghYW50aWJvdGFjdGl2ZXIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgOwogICAgICAgICAgaWYgKHZlcmlmQWRtaW4gfHwgYXV0ZXVyTWVzc2FnZSA9PT0gaWRCb3QpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ2plIGZhaXMgcmllbicpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICA7CiAgICAgICAgICBjb25zdCBrZXkgPSB7CiAgICAgICAgICAgIHJlbW90ZUppZDogb3JpZ2luZU1lc3NhZ2UsCiAgICAgICAgICAgIGZyb21NZTogZmFsc2UsCiAgICAgICAgICAgIGlkOiBtcy5rZXkuaWQsCiAgICAgICAgICAgIHBhcnRpY2lwYW50OiBhdXRldXJNZXNzYWdlCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHR4dCA9ICJib3QgZGV0ZWN0ZWQsIFxuIjsKICAgICAgICAgIC8vIHR4dCArPSBgbWVzc2FnZSBzdXBwcmlt6SBcbiBAJHthdXRldXJNZXNzYWdlLnNwbGl0KCJAIilbMF19IHLpdGly6SBkdSBncm91cGUuYDsKCiAgICAgICAgICB2YXIgc3RpY2tlciA9IG5ldyBTdGlja2VyKCJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vZGphbGVnYTgwMDAvWm9rb3UtTUQvbWFpbi9tZWRpYS9yZW1vdmVyLmdpZiIsIHsKICAgICAgICAgICAgcGFjazogJ0ZFTElYLU1EJywKICAgICAgICAgICAgYXV0aG9yOiBjb25mLk9XTkVSX05BTUUsCiAgICAgICAgICAgIHR5cGU6IFN0aWNrZXJUeXBlcy5GVUxMLAogICAgICAgICAgICBjYXRlZ29yaWVzOiBb//8pJywg//+JJ10sCiAgICAgICAgICAgIGlkOiAnMTIzNDUnLAogICAgICAgICAgICBxdWFsaXR5OiA1MCwKICAgICAgICAgICAgYmFja2dyb3VuZDogJyMwMDAwMDAnCiAgICAgICAgICB9KTsKICAgICAgICAgIGF3YWl0IHN0aWNrZXIudG9GaWxlKCJzdDEud2VicCIpOwogICAgICAgICAgLy8gdmFyIHR4dCA9IGBAJHthdXRldXJNc2dSZXBvbmR1LnNwbGl0KCJAIilbMF19IGEg6XTpIHLpdGly6SBkdSBncm91cGUuLlxuYAogICAgICAgICAgdmFyIGFjdGlvbiA9IGF3YWl0IGF0YnJlY3VwZXJlckFjdGlvbkppZChvcmlnaW5lTWVzc2FnZSk7CiAgICAgICAgICBpZiAoYWN0aW9uID09PSAncmVtb3ZlJykgewogICAgICAgICAgICB0eHQgKz0gYG1lc3NhZ2UgZGVsZXRlZCBcbiBAJHthdXRldXJNZXNzYWdlLnNwbGl0KCJAIilbMF19IHJlbW92ZWQgZnJvbSBncm91cC5gOwogICAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgewogICAgICAgICAgICAgIHN0aWNrZXI6IGZzLnJlYWRGaWxlU3luYygic3QxLndlYnAiKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgMDsKICAgICAgICAgICAgYmFpbGV5c18xLmRlbGF5KDgwMCk7CiAgICAgICAgICAgIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7CiAgICAgICAgICAgICAgdGV4dDogdHh0LAogICAgICAgICAgICAgIG1lbnRpb25zOiBbYXV0ZXVyTWVzc2FnZV0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHF1b3RlZDogbXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgYXdhaXQgemsuZ3JvdXBQYXJ0aWNpcGFudHNVcGRhdGUob3JpZ2luZU1lc3NhZ2UsIFthdXRldXJNZXNzYWdlXSwgInJlbW92ZSIpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coImFudGlib3QgIikgKyBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7CiAgICAgICAgICAgICAgZGVsZXRlOiBrZXkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGF3YWl0IGZzLnVubGluaygic3QxLndlYnAiKTsKICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnZGVsZXRlJykgewogICAgICAgICAgICB0eHQgKz0gYG1lc3NhZ2UgZGVsZXRlIFxuIEAke2F1dGV1ck1lc3NhZ2Uuc3BsaXQoIkAiKVswXX0gQXZvaWQgc2VuZGluZyBsaW5rLmA7CiAgICAgICAgICAgIC8vYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgc3RpY2tlcjogZnMucmVhZEZpbGVTeW5jKCJzdDEud2VicCIpIH0sIHsgcXVvdGVkOiBtcyB9KTsKICAgICAgICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsKICAgICAgICAgICAgICB0ZXh0OiB0eHQsCiAgICAgICAgICAgICAgbWVudGlvbnM6IFthdXRldXJNZXNzYWdlXQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgcXVvdGVkOiBtcwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsKICAgICAgICAgICAgICBkZWxldGU6IGtleQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXdhaXQgZnMudW5saW5rKCJzdDEud2VicCIpOwogICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICd3YXJuJykgewogICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAgZ2V0V2FybkNvdW50QnlKSUQsCiAgICAgICAgICAgICAgYWpvdXRlclV0aWxpc2F0ZXVyQXZlY1dhcm5Db3VudAogICAgICAgICAgICB9ID0gcmVxdWlyZSgnLi9iZGQvd2FybicpOwogICAgICAgICAgICBsZXQgd2FybiA9IGF3YWl0IGdldFdhcm5Db3VudEJ5SklEKGF1dGV1ck1lc3NhZ2UpOwogICAgICAgICAgICBsZXQgd2FybmxpbWl0ID0gY29uZi5XQVJOX0NPVU5UOwogICAgICAgICAgICBpZiAod2FybiA+PSB3YXJubGltaXQpIHsKICAgICAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgewogICAgICAgICAgICAgICAgdGV4dDogYGJvdCBkZXRlY3RlZCA7eW91IHdpbGwgYmUgcmVtb3ZlIGJlY2F1c2Ugb2YgcmVhY2hpbmcgd2Fybi1saW1pdGAsCiAgICAgICAgICAgICAgICBtZW50aW9uczogW2F1dGV1ck1lc3NhZ2VdCiAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgcXVvdGVkOiBtcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGF3YWl0IHprLmdyb3VwUGFydGljaXBhbnRzVXBkYXRlKG9yaWdpbmVNZXNzYWdlLCBbYXV0ZXVyTWVzc2FnZV0sICJyZW1vdmUiKTsKICAgICAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgewogICAgICAgICAgICAgICAgZGVsZXRlOiBrZXkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcmVzdCA9IHdhcm5saW1pdCAtIHdhcm47CiAgICAgICAgICAgICAgYXdhaXQgYWpvdXRlclV0aWxpc2F0ZXVyQXZlY1dhcm5Db3VudChhdXRldXJNZXNzYWdlKTsKICAgICAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgewogICAgICAgICAgICAgICAgdGV4dDogYGJvdCBkZXRlY3RlZCAsIHlvdXIgd2Fybl9jb3VudCB3YXMgdXBncmFkZSA7XG4gcmVzdCA6ICR7cmVzdH0gYCwKICAgICAgICAgICAgICAgIG1lbnRpb25zOiBbYXV0ZXVyTWVzc2FnZV0KICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBxdW90ZWQ6IG1zCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsKICAgICAgICAgICAgICAgIGRlbGV0ZToga2V5CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVyKSB7CiAgICAgICAgY29uc29sZS5sb2coJy4uLi4gJyArIGVyKTsKICAgICAgfQoKICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgLy9leGVjdXRpb24gZGVzIGNvbW1hbmRlcyAgIAogICAgICBpZiAodmVyaWZDb20pIHsKICAgICAgICBjb25zdCBjZCA9IGV2dC5jbS5maW5kKGhhbnMgPT4gaGFucy5ub21Db20gPT09IGNvbSB8fCBoYW5zLm5vbUNvbSA9PT0gY29tIHx8IGhhbnMuYWxpYXNlcyAmJiBoYW5zLmFsaWFzZXMuaW5jbHVkZXMoY29tKSk7CiAgICAgICAgaWYgKGNkKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uZi5NT0RFLnRvTG9jYWxlTG93ZXJDYXNlKCkgIT0gJ3llcycgJiYgIXN1cGVyVXNlcikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqKioqKioqKioqKioqKioqKiogUE1fUEVSTVQqKioqKioqKioqKioqKiovCgogICAgICAgICAgICBpZiAoIXN1cGVyVXNlciAmJiBvcmlnaW5lTWVzc2FnZSA9PT0gYXV0ZXVyTWVzc2FnZSAmJiBjb25mLlBNX1BFUk1JVCA9PT0gInllcyIpIHsKICAgICAgICAgICAgICByZXBvbmRyZSgiU09SUlkhISdMXG5cbllvdSBkb24ndCBoYXZlIGFjY2VzIHRvIGNvbW1hbmRzIGhlcmUgaWRpb3QiKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqYmFuR3JvdXAgICovCiAgICAgICAgICAgIGlmICghc3VwZXJVc2VyICYmIHZlcmlmR3JvdXBlKSB7CiAgICAgICAgICAgICAgbGV0IHJlcSA9IGF3YWl0IGlzR3JvdXBCYW5uZWQob3JpZ2luZU1lc3NhZ2UpOwogICAgICAgICAgICAgIGlmIChyZXEpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKiogIE9OTFktQURNSU4gICovCgogICAgICAgICAgICBpZiAoIXZlcmlmQWRtaW4gJiYgdmVyaWZHcm91cGUpIHsKICAgICAgICAgICAgICBsZXQgcmVxID0gYXdhaXQgaXNHcm91cE9ubHlBZG1pbihvcmlnaW5lTWVzc2FnZSk7CiAgICAgICAgICAgICAgaWYgKHJlcSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqKioqKioqKioqKioqKioqKioqKipiYW51c2VyICovCgogICAgICAgICAgICBpZiAoIXN1cGVyVXNlcikgewogICAgICAgICAgICAgIGxldCByZXEgPSBhd2FpdCBpc1VzZXJCYW5uZWQoYXV0ZXVyTWVzc2FnZSk7CiAgICAgICAgICAgICAgaWYgKHJlcSkgewogICAgICAgICAgICAgICAgcmVwb25kcmUoIllvdSBhcmUgYmFubmVkIGZyb20gYm90IGNvbW1hbmRzIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlYWdpcihvcmlnaW5lTWVzc2FnZSwgemssIG1zLCBjZC5yZWFjdGlvbik7CiAgICAgICAgICAgIGNkLmZvbmN0aW9uKG9yaWdpbmVNZXNzYWdlLCB6aywgY29tbWFuZGVPcHRpb25zKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2co+v8h/yEgIiArIGUpOwogICAgICAgICAgICB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgewogICAgICAgICAgICAgIHRleHQ6IPo9+f8hICIgKyBlCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBxdW90ZWQ6IG1zCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvL2ZpbiBleOljdXRpb24gY29tbWFuZGVzCiAgICB9KTsKICAgIC8vZmluIOl26W5lbWVudCBtZXNzYWdlCgogICAgLyoqKioqKioqIGV2ZW5lbWVudCBncm91cGUgdXBkYXRlICoqKioqKioqKioqKioqKiovCiAgICBjb25zdCB7CiAgICAgIHJlY3VwZXZlbnRzCiAgICB9ID0gcmVxdWlyZSgnLi9iZGQvd2VsY29tZScpOwogICAgemsuZXYub24oJ2dyb3VwLXBhcnRpY2lwYW50cy51cGRhdGUnLCBhc3luYyBncm91cCA9PiB7CiAgICAgIGNvbnNvbGUubG9nKGdyb3VwKTsKICAgICAgbGV0IHBwZ3JvdXA7CiAgICAgIHRyeSB7CiAgICAgICAgcHBncm91cCA9IGF3YWl0IHprLnByb2ZpbGVQaWN0dXJlVXJsKGdyb3VwLmlkLCAnaW1hZ2UnKTsKICAgICAgfSBjYXRjaCB7CiAgICAgICAgcHBncm91cCA9ICdodHRwczovL2ZpbGVzLmNhdGJveC5tb2UvNXB1OTZyLndlYnAnOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCB6ay5ncm91cE1ldGFkYXRhKGdyb3VwLmlkKTsKICAgICAgICBpZiAoZ3JvdXAuYWN0aW9uID09ICdhZGQnICYmIChhd2FpdCByZWN1cGV2ZW50cyhncm91cC5pZCwgIndlbGNvbWUiKSkgPT0gJ29uJykgewogICAgICAgICAgbGV0IG1zZyA9IPg9SyBIZWxsbwpgOwogICAgICAgICAgbGV0IG1lbWJyZXMgPSBncm91cC5wYXJ0aWNpcGFudHM7CiAgICAgICAgICBmb3IgKGxldCBtZW1icmUgb2YgbWVtYnJlcykgewogICAgICAgICAgICBtc2cgKz0gYCAqQCR7bWVtYnJlLnNwbGl0KCJAIilbMF19KiBXZWxjb21lIHRvIE91ciBPZmZpY2lhbCBHcm91cCxgOwogICAgICAgICAgfQogICAgICAgICAgbXNnICs9IGBZb3UgbWlnaHQgd2FudCB0byByZWFkIHRoZSBncm91cCBEZXNjcmlwdGlvbiB0byBhdm9pZCBnZXR0aW5nIHJlbW92ZWQuLi5gOwogICAgICAgICAgemsuc2VuZE1lc3NhZ2UoZ3JvdXAuaWQsIHsKICAgICAgICAgICAgaW1hZ2U6IHsKICAgICAgICAgICAgICB1cmw6IHBwZ3JvdXAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FwdGlvbjogbXNnLAogICAgICAgICAgICBtZW50aW9uczogbWVtYnJlcwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChncm91cC5hY3Rpb24gPT0gJ3JlbW92ZScgJiYgKGF3YWl0IHJlY3VwZXZlbnRzKGdyb3VwLmlkLCAiZ29vZGJ5ZSIpKSA9PSAnb24nKSB7CiAgICAgICAgICBsZXQgbXNnID0gYG9uZSBvciBzb21lcyBtZW1iZXIocykgbGVmdCBncm91cDtcbmA7CiAgICAgICAgICBsZXQgbWVtYnJlcyA9IGdyb3VwLnBhcnRpY2lwYW50czsKICAgICAgICAgIGZvciAobGV0IG1lbWJyZSBvZiBtZW1icmVzKSB7CiAgICAgICAgICAgIG1zZyArPSBgQCR7bWVtYnJlLnNwbGl0KCJAIilbMF19XG5gOwogICAgICAgICAgfQogICAgICAgICAgemsuc2VuZE1lc3NhZ2UoZ3JvdXAuaWQsIHsKICAgICAgICAgICAgdGV4dDogbXNnLAogICAgICAgICAgICBtZW50aW9uczogbWVtYnJlcwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChncm91cC5hY3Rpb24gPT0gJ3Byb21vdGUnICYmIChhd2FpdCByZWN1cGV2ZW50cyhncm91cC5pZCwgImFudGlwcm9tb3RlIikpID09ICdvbicpIHsKICAgICAgICAgIC8vICBjb25zb2xlLmxvZyh6ay51c2VyLmlkKQogICAgICAgICAgaWYgKGdyb3VwLmF1dGhvciA9PSBtZXRhZGF0YS5vd25lciB8fCBncm91cC5hdXRob3IgPT0gY29uZi5OVU1FUk9fT1dORVIgKyAnQHMud2hhdHNhcHAubmV0JyB8fCBncm91cC5hdXRob3IgPT0gZGVjb2RlSmlkKHprLnVzZXIuaWQpIHx8IGdyb3VwLmF1dGhvciA9PSBncm91cC5wYXJ0aWNpcGFudHNbMF0pIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0NhcyBkZSBzdXBlclVzZXIgamUgZmFpcyByaWVuJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIDsKICAgICAgICAgIGF3YWl0IHprLmdyb3VwUGFydGljaXBhbnRzVXBkYXRlKGdyb3VwLmlkLCBbZ3JvdXAuYXV0aG9yLCBncm91cC5wYXJ0aWNpcGFudHNbMF1dLCAiZGVtb3RlIik7CiAgICAgICAgICB6ay5zZW5kTWVzc2FnZShncm91cC5pZCwgewogICAgICAgICAgICB0ZXh0OiBgQCR7Z3JvdXAuYXV0aG9yLnNwbGl0KCJAIilbMF19IGhhcyB2aW9sYXRlZCB0aGUgYW50aS1wcm9tb3Rpb24gcnVsZSwgdGhlcmVmb3JlIGJvdGggJHtncm91cC5hdXRob3Iuc3BsaXQoIkAiKVswXX0gYW5kIEAke2dyb3VwLnBhcnRpY2lwYW50c1swXS5zcGxpdCgiQCIpWzBdfSBoYXZlIGJlZW4gcmVtb3ZlZCBmcm9tIGFkbWluaXN0cmF0aXZlIHJpZ2h0cy5gLAogICAgICAgICAgICBtZW50aW9uczogW2dyb3VwLmF1dGhvciwgZ3JvdXAucGFydGljaXBhbnRzWzBdXQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChncm91cC5hY3Rpb24gPT0gJ2RlbW90ZScgJiYgKGF3YWl0IHJlY3VwZXZlbnRzKGdyb3VwLmlkLCAiYW50aWRlbW90ZSIpKSA9PSAnb24nKSB7CiAgICAgICAgICBpZiAoZ3JvdXAuYXV0aG9yID09IG1ldGFkYXRhLm93bmVyIHx8IGdyb3VwLmF1dGhvciA9PSBjb25mLk5VTUVST19PV05FUiArICdAcy53aGF0c2FwcC5uZXQnIHx8IGdyb3VwLmF1dGhvciA9PSBkZWNvZGVKaWQoemsudXNlci5pZCkgfHwgZ3JvdXAuYXV0aG9yID09IGdyb3VwLnBhcnRpY2lwYW50c1swXSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnQ2FzIGRlIHN1cGVyVXNlciBqZSBmYWlzIHJpZW4nKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgOwogICAgICAgICAgYXdhaXQgemsuZ3JvdXBQYXJ0aWNpcGFudHNVcGRhdGUoZ3JvdXAuaWQsIFtncm91cC5hdXRob3JdLCAiZGVtb3RlIik7CiAgICAgICAgICBhd2FpdCB6ay5ncm91cFBhcnRpY2lwYW50c1VwZGF0ZShncm91cC5pZCwgW2dyb3VwLnBhcnRpY2lwYW50c1swXV0sICJwcm9tb3RlIik7CiAgICAgICAgICB6ay5zZW5kTWVzc2FnZShncm91cC5pZCwgewogICAgICAgICAgICB0ZXh0OiBgQCR7Z3JvdXAuYXV0aG9yLnNwbGl0KCJAIilbMF19IGhhcyB2aW9sYXRlZCB0aGUgYW50aS1kZW1vdGlvbiBydWxlIGJ5IHJlbW92aW5nIEAke2dyb3VwLnBhcnRpY2lwYW50c1swXS5zcGxpdCgiQCIpWzBdfS4gQ29uc2VxdWVudGx5LCBoZSBoYXMgYmVlbiBzdHJpcHBlZCBvZiBhZG1pbmlzdHJhdGl2ZSByaWdodHMuYCwKICAgICAgICAgICAgbWVudGlvbnM6IFtncm91cC5hdXRob3IsIGdyb3VwLnBhcnRpY2lwYW50c1swXV0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgIH0KICAgIH0pOwoKICAgIC8qKioqKioqKiBmaW4gZCdldmVuZW1lbnQgZ3JvdXBlIHVwZGF0ZSAqKioqKioqKioqKioqKioqKioqKioqKioqLwoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKkNyb24gc2V0dXAgKi8KCiAgICBhc3luYyBmdW5jdGlvbiBhY3RpdmF0ZUNyb25zKCkgewogICAgICBjb25zdCBjcm9uID0gcmVxdWlyZSgnbm9kZS1jcm9uJyk7CiAgICAgIGNvbnN0IHsKICAgICAgICBnZXRDcm9uCiAgICAgIH0gPSByZXF1aXJlKCcuL2JkZC9jcm9uJyk7CiAgICAgIGxldCBjcm9ucyA9IGF3YWl0IGdldENyb24oKTsKICAgICAgY29uc29sZS5sb2coY3JvbnMpOwogICAgICBpZiAoY3JvbnMubGVuZ3RoID4gMCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY3JvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChjcm9uc1tpXS5tdXRlX2F0ICE9IG51bGwpIHsKICAgICAgICAgICAgbGV0IHNldCA9IGNyb25zW2ldLm11dGVfYXQuc3BsaXQoJzonKTsKICAgICAgICAgICAgY29uc29sZS5sb2coYGV0YWJsaXNzZW1lbnQgZCd1biBhdXRvbXV0ZSBwb3VyICR7Y3JvbnNbaV0uZ3JvdXBfaWR9IGEgJHtzZXRbMF19IEggJHtzZXRbMV19YCk7CiAgICAgICAgICAgIGNyb24uc2NoZWR1bGUoYCR7c2V0WzFdfSAke3NldFswXX0gKiAqICpgLCBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgICAgYXdhaXQgemsuZ3JvdXBTZXR0aW5nVXBkYXRlKGNyb25zW2ldLmdyb3VwX2lkLCAnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgICAgemsuc2VuZE1lc3NhZ2UoY3JvbnNbaV0uZ3JvdXBfaWQsIHsKICAgICAgICAgICAgICAgIGltYWdlOiB7CiAgICAgICAgICAgICAgICAgIHVybDogJy4vbWVkaWEvY2hyb25vLndlYnAnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2FwdGlvbjogIkhlbGxvLCBpdCdzIHRpbWUgdG8gY2xvc2UgdGhlIGdyb3VwOyBzYXlvbmFyYS4iCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICB0aW1lem9uZTogIkFmcmljYS9OYWlyb2JpIgogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjcm9uc1tpXS51bm11dGVfYXQgIT0gbnVsbCkgewogICAgICAgICAgICBsZXQgc2V0ID0gY3JvbnNbaV0udW5tdXRlX2F0LnNwbGl0KCc6Jyk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBldGFibGlzc2VtZW50IGQndW4gYXV0b3VubXV0ZSBwb3VyICR7c2V0WzBdfSBIICR7c2V0WzFdfSBgKTsKICAgICAgICAgICAgY3Jvbi5zY2hlZHVsZShgJHtzZXRbMV19ICR7c2V0WzBdfSAqICogKmAsIGFzeW5jICgpID0+IHsKICAgICAgICAgICAgICBhd2FpdCB6ay5ncm91cFNldHRpbmdVcGRhdGUoY3JvbnNbaV0uZ3JvdXBfaWQsICdub3RfYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgICAgemsuc2VuZE1lc3NhZ2UoY3JvbnNbaV0uZ3JvdXBfaWQsIHsKICAgICAgICAgICAgICAgIGltYWdlOiB7CiAgICAgICAgICAgICAgICAgIHVybDogJy4vbWVkaWEvY2hyb25vLndlYnAnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2FwdGlvbjogIkdvb2QgbW9ybmluZzsgSXQncyB0aW1lIHRvIG9wZW4gdGhlIGdyb3VwLiIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHRpbWV6b25lOiAiQWZyaWNhL1RhbnphbmlhIgogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coIkxlcyBjcm9ucyBuJ29udCBwYXMg6XTpIGFjdGl26XMiKTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CgogICAgLy/pduluZW1lbnQgY29udGFjdAogICAgemsuZXYub24oImNvbnRhY3RzLnVwc2VydCIsIGFzeW5jIGNvbnRhY3RzID0+IHsKICAgICAgY29uc3QgaW5zZXJ0Q29udGFjdCA9IG5ld0NvbnRhY3QgPT4gewogICAgICAgIGZvciAoY29uc3QgY29udGFjdCBvZiBuZXdDb250YWN0KSB7CiAgICAgICAgICBpZiAoc3RvcmUuY29udGFjdHNbY29udGFjdC5pZF0pIHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihzdG9yZS5jb250YWN0c1tjb250YWN0LmlkXSwgY29udGFjdCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdG9yZS5jb250YWN0c1tjb250YWN0LmlkXSA9IGNvbnRhY3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgICAgfTsKICAgICAgaW5zZXJ0Q29udGFjdChjb250YWN0cyk7CiAgICB9KTsKICAgIC8vZmluIOl26W5lbWVudCBjb250YWN0IAogICAgLy/pduluZW1lbnQgY29ubmV4aW9uCiAgICB6ay5ldi5vbigiY29ubmVjdGlvbi51cGRhdGUiLCBhc3luYyBjb24gPT4gewogICAgICBjb25zdCB7CiAgICAgICAgbGFzdERpc2Nvbm5lY3QsCiAgICAgICAgY29ubmVjdGlvbgogICAgICB9ID0gY29uOwogICAgICBpZiAoY29ubmVjdGlvbiA9PT0gImNvbm5lY3RpbmciKSB7CiAgICAgICAgY29uc29sZS5sb2coI/8PIEZlbGl4IE1kIGNvbm5lY3RpbmcgaW4geW91ciBhY2NvdW50Li4uIik7CiAgICAgIH0gZWxzZSBpZiAoY29ubmVjdGlvbiA9PT0gJ29wZW4nKSB7CiAgICAgICAgYXdhaXQgemsuZ3JvdXBBY2NlcHRJbnZpdGUoIkR2WG9uZXBQcDFYQlBPWUlCemlUbDEiKTsKICAgICAgICBjb25zb2xlLmxvZygiBSBGZWxpeCBNZCBjb25uZWN0ZWQgc3VjY2Vzc2Z1bGx5FCIpOwogICAgICAgIGNvbnNvbGUubG9nKCItLSIpOwogICAgICAgIDA7CiAgICAgICAgYXdhaXQgYmFpbGV5c18xLmRlbGF5KDIwMCk7CiAgICAgICAgY29uc29sZS5sb2coIi0tLS0tLSIpOwogICAgICAgIDA7CiAgICAgICAgYXdhaXQgYmFpbGV5c18xLmRlbGF5KDMwMCk7CiAgICAgICAgY29uc29sZS5sb2coIi0tLS0tLS0tLS0tLS0tLS0tLS8tLS0tLSIpOwogICAgICAgIGNvbnNvbGUubG9nKCIgRkVMSVgtTUQgaW5zdGFsbGluZyAke2V2dC5jbS5sZW5ndGh9IHBsdWdpbvs9B1xuXG4iKTsKICAgICAgICAvL2NoYXJnZW1lbnQgZGVzIGNvbW1hbmRlcyAKICAgICAgICBjb25zb2xlLmxvZygiY2hhcmdlbWVudCBkZXMgY29tbWFuZHMgLi4uXG4iKTsKICAgICAgICBmcy5yZWFkZGlyU3luYyhfX2Rpcm5hbWUgKyAiL2NvbW1hbmRzIikuZm9yRWFjaChmaWNoaWVyID0+IHsKICAgICAgICAgIGlmIChwYXRoLmV4dG5hbWUoZmljaGllcikudG9Mb3dlckNhc2UoKSA9PSAiLmpzIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlcXVpcmUoX19kaXJuYW1lICsgIi9jb21tYW5kcy8iICsgZmljaGllcik7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coZmljaGllciArICJTdWNjZXNzZnVsbHkgaW5zdGFsbGVkIEZlbGl4IE1kIGNvbW1hbmRz/g8iKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke2ZpY2hpZXJ9IG4nYSBwYXMgcHUg6nRyZSBjaGFyZ+kgcG91ciBsZXMgcmFpc29ucyBzdWl2YW50ZXMgOiAke2V9YCk7CiAgICAgICAgICAgIH0gLyogcmVxdWlyZShfX2Rpcm5hbWUgKyAiL2NvbW1hbmRzLyIgKyBmaWNoaWVyKTsKICAgICAgICAgICAgICBjb25zb2xlLmxvZyhmaWNoaWVyICsgIiBpbnN0YWxs6ScUDyIpKi8KICAgICAgICAgICAgMDsKICAgICAgICAgICAgYmFpbGV5c18xLmRlbGF5KDMwMCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgMDsKICAgICAgICBiYWlsZXlzXzEuZGVsYXkoNzAwKTsKICAgICAgICB2YXIgbWQ7CiAgICAgICAgaWYgKGNvbmYuTU9ERS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAieWVzIikgewogICAgICAgICAgbWQgPSAicHVibGljIjsKICAgICAgICB9IGVsc2UgaWYgKGNvbmYuTU9ERS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAibm8iKSB7CiAgICAgICAgICBtZCA9ICJwcml2YXRlIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWQgPSAidW5kZWZpbmVkIjsKICAgICAgICB9CiAgICAgICAgY29uc29sZS5sb2coIkZlbGl4IE1kIHN1Y2Nlc3NmdWxseSBjb25uZWN0ZWcFIik7CiAgICAgICAgYXdhaXQgYWN0aXZhdGVDcm9ucygpOwogICAgICAgIGlmIChjb25mLkRQLnRvTG93ZXJDYXNlKCkgPT09ICd5ZXMnKSB7CiAgICAgICAgICBhd2FpdCB6ay5zZW5kTWVzc2FnZSh6ay51c2VyLmlkLCB7CiAgICAgICAgICAgIHRleHQ6IGVtdXVQcrcKUSAqDkZFTElY/f0M/QMg/fo1LPg13v0n/f01+v0n/T4PKi9RICAgIENyZWF0b3I6ICpIQU5TVFoqL1EgICAgUHJlZml4IDogWyAgJHtwcmVmaXhlfSBdL1EgICAgTW9kZSA6ICR7bWR9IG1vZGUKUSAgICBUb3RhbCBDb21tYW5kcyA6ICR7ZXZ0LmNtLmxlbmd0aH0KdXVQdXVQdXVQdXVQdXVQdXVQtwoKbSUAJccKAy8DICpUaGFuayB5b3UgZm9yIGNob29zaW5nKiAgICAgICAgICAgICAgICAgICAgICAKAyAqRkVMSVgtTUQqCiA+IFJlZ2FyZHMgSEFOU1RaIC9wdXVQdXVQdXVQdXVQdXVQdXK3IGAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChjb25uZWN0aW9uID09ICJjbG9zZSIpIHsKICAgICAgICBsZXQgcmFpc29uRGVjb25uZXhpb24gPSBuZXcgYm9vbV8xLkJvb20obGFzdERpc2Nvbm5lY3Q/LmVycm9yKT8ub3V0cHV0LnN0YXR1c0NvZGU7CiAgICAgICAgaWYgKHJhaXNvbkRlY29ubmV4aW9uID09PSBiYWlsZXlzXzEuRGlzY29ubmVjdFJlYXNvbi5iYWRTZXNzaW9uKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnV3Jvbmcgc2Vzc2lvbiBJZCBmb3JtYXQsIHJlc2NhbiBhZ2Fpbi4uLicpOwogICAgICAgIH0gZWxzZSBpZiAocmFpc29uRGVjb25uZXhpb24gPT09IGJhaWxleXNfMS5EaXNjb25uZWN0UmVhc29uLmNvbm5lY3Rpb25DbG9zZWQpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCchISEgY29ubmV4aW9uIGZlcm3pZSwgcmVjb25uZXhpb24gZW4gY291cnMgLi4uJyk7CiAgICAgICAgICBtYWluKCk7CiAgICAgICAgfSBlbHNlIGlmIChyYWlzb25EZWNvbm5leGlvbiA9PT0gYmFpbGV5c18xLkRpc2Nvbm5lY3RSZWFzb24uY29ubmVjdGlvbkxvc3QpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdjb25uZWN0aW9uIGVycm9y/x4gLCxGZWxpeCB0cnlpbmcgdG8gcmVjb25uZWN0Li4uICcpOwogICAgICAgICAgbWFpbigpOwogICAgICAgIH0gZWxzZSBpZiAocmFpc29uRGVjb25uZXhpb24gPT09IGJhaWxleXNfMS5EaXNjb25uZWN0UmVhc29uPy5jb25uZWN0aW9uUmVwbGFjZWQpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdjb25uZXhpb24gculwbGFj6WUgLCwsIHVuZSBzZXNzc2lvbiBlc3QgZOlq4CBvdXZlcnRlIHZldWlsbGV6IGxhIGZlcm1lciBzdnAgISEhJyk7CiAgICAgICAgfSBlbHNlIGlmIChyYWlzb25EZWNvbm5leGlvbiA9PT0gYmFpbGV5c18xLkRpc2Nvbm5lY3RSZWFzb24ubG9nZ2VkT3V0KSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnc2Vzc2lvbiBkaXNjb25uZWN0ZWQsLCwgcmVwbGFjZSBhIG5ldyBzZXNzaW9uIGlkJyk7CiAgICAgICAgfSBlbHNlIGlmIChyYWlzb25EZWNvbm5leGlvbiA9PT0gYmFpbGV5c18xLkRpc2Nvbm5lY3RSZWFzb24ucmVzdGFydFJlcXVpcmVkKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygncmVk6W1hcnJhZ2UgZW4gY291cnMg/g8nKTsKICAgICAgICAgIG1haW4oKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5sb2coInJlZGVtYXJyYWdlIHN1ciBsZSBjb3VwIGRlIGwnZXJyZXVyICAiLCByYWlzb25EZWNvbm5leGlvbik7CiAgICAgICAgICAvL3JlcG9uZHJlKCIqIFJlZOltYXJyYWdlIGR1IGJvdCBlbiBjb3VyIC4uLioiKTsKCiAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgIGV4ZWMKICAgICAgICAgIH0gPSByZXF1aXJlKCJjaGlsZF9wcm9jZXNzIik7CiAgICAgICAgICBleGVjKCJwbTIgcmVzdGFydCBhbGwiKTsKICAgICAgICB9CiAgICAgICAgLy8gc2xlZXAoNTAwMDApCiAgICAgICAgY29uc29sZS5sb2coImh1bSAiICsgY29ubmVjdGlvbik7CiAgICAgICAgbWFpbigpOyAvL2NvbnNvbGUubG9nKHNlc3Npb24pCiAgICAgIH0KICAgIH0pOwogICAgLy9maW4g6XbpbmVtZW50IGNvbm5leGlvbgogICAgLy/pduluZW1lbnQgYXV0aGVudGlmaWNhdGlvbiAKICAgIHprLmV2Lm9uKCJjcmVkcy51cGRhdGUiLCBzYXZlQ3JlZHMpOwogICAgLy9maW4g6XbpbmVtZW50IGF1dGhlbnRpZmljYXRpb24gCiAgICAvLwogICAgLyoqICoqKioqKioqKioqKiogKi8KICAgIC8vZm9uY3Rpb25zIHV0aWxlcwogICAgemsuZG93bmxvYWRBbmRTYXZlTWVkaWFNZXNzYWdlID0gYXN5bmMgKG1lc3NhZ2UsIGZpbGVuYW1lID0gJycsIGF0dGFjaEV4dGVuc2lvbiA9IHRydWUpID0+IHsKICAgICAgbGV0IHF1b3RlZCA9IG1lc3NhZ2UubXNnID8gbWVzc2FnZS5tc2cgOiBtZXNzYWdlOwogICAgICBsZXQgbWltZSA9IChtZXNzYWdlLm1zZyB8fCBtZXNzYWdlKS5taW1ldHlwZSB8fCAnJzsKICAgICAgbGV0IG1lc3NhZ2VUeXBlID0gbWVzc2FnZS5tdHlwZSA/IG1lc3NhZ2UubXR5cGUucmVwbGFjZSgvTWVzc2FnZS9naSwgJycpIDogbWltZS5zcGxpdCgnLycpWzBdOwogICAgICAwOwogICAgICBjb25zdCBzdHJlYW0gPSBhd2FpdCBiYWlsZXlzXzEuZG93bmxvYWRDb250ZW50RnJvbU1lc3NhZ2UocXVvdGVkLCBtZXNzYWdlVHlwZSk7CiAgICAgIGxldCBidWZmZXIgPSBCdWZmZXIuZnJvbShbXSk7CiAgICAgIGZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2Ygc3RyZWFtKSB7CiAgICAgICAgYnVmZmVyID0gQnVmZmVyLmNvbmNhdChbYnVmZmVyLCBjaHVua10pOwogICAgICB9CiAgICAgIGxldCB0eXBlID0gYXdhaXQgRmlsZVR5cGUuZnJvbUJ1ZmZlcihidWZmZXIpOwogICAgICBsZXQgdHJ1ZUZpbGVOYW1lID0gJy4vJyArIGZpbGVuYW1lICsgJy4nICsgdHlwZS5leHQ7CiAgICAgIC8vIHNhdmUgdG8gZmlsZQogICAgICBhd2FpdCBmcy53cml0ZUZpbGVTeW5jKHRydWVGaWxlTmFtZSwgYnVmZmVyKTsKICAgICAgcmV0dXJuIHRydWVGaWxlTmFtZTsKICAgIH07CiAgICB6ay5hd2FpdEZvck1lc3NhZ2UgPSBhc3luYyAob3B0aW9ucyA9IHt9KSA9PiB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSAnb2JqZWN0JykgewogICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignT3B0aW9ucyBtdXN0IGJlIGFuIG9iamVjdCcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnNlbmRlciAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ1NlbmRlciBtdXN0IGJlIGEgc3RyaW5nJykpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuY2hhdEppZCAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ0NoYXRKaWQgbXVzdCBiZSBhIHN0cmluZycpKTsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMudGltZW91dCAmJiB0eXBlb2Ygb3B0aW9ucy50aW1lb3V0ICE9PSAnbnVtYmVyJykgewogICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignVGltZW91dCBtdXN0IGJlIGEgbnVtYmVyJykpOwogICAgICAgIH0KICAgICAgICBpZiAob3B0aW9ucy5maWx0ZXIgJiYgdHlwZW9mIG9wdGlvbnMuZmlsdGVyICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdGaWx0ZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJykpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0aW1lb3V0ID0gb3B0aW9ucz8udGltZW91dCB8fCB1bmRlZmluZWQ7CiAgICAgICAgY29uc3QgZmlsdGVyID0gb3B0aW9ucz8uZmlsdGVyIHx8ICgoKSA9PiB0cnVlKTsKICAgICAgICBsZXQgaW50ZXJ2YWwgPSB1bmRlZmluZWQ7CgogICAgICAgIC8qKgogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7e21lc3NhZ2VzOiBCYWlsZXlzLnByb3RvLklXZWJNZXNzYWdlSW5mb1tdLCB0eXBlOiBCYWlsZXlzLk1lc3NhZ2VVcHNlcnRUeXBlfX0gZGF0YSAKICAgICAgICAgKi8KICAgICAgICBsZXQgbGlzdGVuZXIgPSBkYXRhID0+IHsKICAgICAgICAgIGxldCB7CiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIG1lc3NhZ2VzCiAgICAgICAgICB9ID0gZGF0YTsKICAgICAgICAgIGlmICh0eXBlID09ICJub3RpZnkiKSB7CiAgICAgICAgICAgIGZvciAobGV0IG1lc3NhZ2Ugb2YgbWVzc2FnZXMpIHsKICAgICAgICAgICAgICBjb25zdCBmcm9tTWUgPSBtZXNzYWdlLmtleS5mcm9tTWU7CiAgICAgICAgICAgICAgY29uc3QgY2hhdElkID0gbWVzc2FnZS5rZXkucmVtb3RlSmlkOwogICAgICAgICAgICAgIGNvbnN0IGlzR3JvdXAgPSBjaGF0SWQuZW5kc1dpdGgoJ0BnLnVzJyk7CiAgICAgICAgICAgICAgY29uc3QgaXNTdGF0dXMgPSBjaGF0SWQgPT0gJ3N0YXR1c0Bicm9hZGNhc3QnOwogICAgICAgICAgICAgIGNvbnN0IHNlbmRlciA9IGZyb21NZSA/IHprLnVzZXIuaWQucmVwbGFjZSgvOi4qQC9nLCAnQCcpIDogaXNHcm91cCB8fCBpc1N0YXR1cyA/IG1lc3NhZ2Uua2V5LnBhcnRpY2lwYW50LnJlcGxhY2UoLzouKkAvZywgJ0AnKSA6IGNoYXRJZDsKICAgICAgICAgICAgICBpZiAoc2VuZGVyID09IG9wdGlvbnMuc2VuZGVyICYmIGNoYXRJZCA9PSBvcHRpb25zLmNoYXRKaWQgJiYgZmlsdGVyKG1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICB6ay5ldi5vZmYoJ21lc3NhZ2VzLnVwc2VydCcsIGxpc3RlbmVyKTsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChpbnRlcnZhbCk7CiAgICAgICAgICAgICAgICByZXNvbHZlKG1lc3NhZ2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgemsuZXYub24oJ21lc3NhZ2VzLnVwc2VydCcsIGxpc3RlbmVyKTsKICAgICAgICBpZiAodGltZW91dCkgewogICAgICAgICAgaW50ZXJ2YWwgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgemsuZXYub2ZmKCdtZXNzYWdlcy51cHNlcnQnLCBsaXN0ZW5lcik7CiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ1RpbWVvdXQnKSk7CiAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICAvLyBmaW4gZm9uY3Rpb25zIHV0aWxlcwogICAgLyoqICoqKioqKioqKioqKiogKi8KICAgIHJldHVybiB6azsKICB9CiAgbGV0IGZpY2hpZXIgPSByZXF1aXJlLnJlc29sdmUoX19maWxlbmFtZSk7CiAgZnMud2F0Y2hGaWxlKGZpY2hpZXIsICgpID0+IHsKICAgIGZzLnVud2F0Y2hGaWxlKGZpY2hpZXIpOwogICAgY29uc29sZS5sb2coYG1pc2Ug4CBqb3VyICR7X19maWxlbmFtZX1gKTsKICAgIGRlbGV0ZSByZXF1aXJlLmNhY2hlW2ZpY2hpZXJdOwogICAgcmVxdWlyZShmaWNoaWVyKTsKICB9KTsKICBtYWluKCk7Cn0sIDUwMDApOwo=